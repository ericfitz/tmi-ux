<h1 mat-dialog-title>History</h1>

<div mat-dialog-content appScrollIndicator class="history-content">
  <!-- Summary Section -->
  <details class="history-section" open>
    <summary class="history-section-header">
      <mat-icon class="expand-icon">expand_more</mat-icon>
      <strong>Summary</strong>
    </summary>
    <div class="history-section-content">
      <div class="summary-grid">
        <div class="summary-item">
          <span class="label">Can Undo:</span>
          <span class="value">{{ summary.canUndo }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Can Redo:</span>
          <span class="value">{{ summary.canRedo }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Undo Stack Size:</span>
          <span class="value">{{ summary.undoStackSize }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Redo Stack Size:</span>
          <span class="value">{{ summary.redoStackSize }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Max Stack Size:</span>
          <span class="value">{{ summary.maxStackSize }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Current Index:</span>
          <span class="value">{{ summary.currentIndex }}</span>
        </div>
      </div>
    </div>
  </details>

  <!-- Undo Stack Section -->
  <details class="history-section" [attr.open]="undoStack.length > 0 ? true : null">
    <summary class="history-section-header">
      <mat-icon class="expand-icon">expand_more</mat-icon>
      <strong>Undo Stack</strong>
      <span class="count-badge">({{ undoStack.length }})</span>
    </summary>
    <div class="history-section-content">
      @if (undoStack.length === 0) {
        <div class="empty-state">No undo entries</div>
      } @else {
        @for (entry of undoStack; track entry.id) {
          <details class="history-entry">
            <summary class="history-entry-header">
              <mat-icon class="expand-icon">chevron_right</mat-icon>
              <span class="entry-index">#{{ entry.index }}</span>
              <span class="entry-type">{{ entry.operationType }}</span>
              <span class="entry-description">{{ entry.description }}</span>
              <span class="entry-time">{{ entry.timestampFormatted }}</span>
            </summary>
            <div class="history-entry-content">
              <div class="entry-detail">
                <span class="label">ID:</span>
                <code class="value">{{ entry.id }}</code>
              </div>
              <div class="entry-detail">
                <span class="label">Timestamp:</span>
                <span class="value">{{ entry.timestamp }}</span>
              </div>
              <div class="entry-detail">
                <span class="label">Affected Cells:</span>
                <span class="value">{{ entry.affectedCellCount }}</span>
              </div>
              @if (entry.affectedCellIds.length > 0) {
                <div class="entry-detail">
                  <span class="label">Cell IDs:</span>
                  <code class="value">{{ entry.affectedCellIds.join(', ') }}</code>
                </div>
              }
              @if (entry.userId) {
                <div class="entry-detail">
                  <span class="label">User ID:</span>
                  <code class="value">{{ entry.userId }}</code>
                </div>
              }
              @if (entry.operationId) {
                <div class="entry-detail">
                  <span class="label">Operation ID:</span>
                  <code class="value">{{ entry.operationId }}</code>
                </div>
              }
              @if (entry.metadata) {
                <details class="nested-detail">
                  <summary class="nested-summary">
                    <mat-icon class="expand-icon">chevron_right</mat-icon>
                    Metadata
                  </summary>
                  <pre class="json-content">{{ entry.metadata | json }}</pre>
                </details>
              }
              <details class="nested-detail">
                <summary class="nested-summary">
                  <mat-icon class="expand-icon">chevron_right</mat-icon>
                  Cells ({{ entry.affectedCellCount }})
                </summary>
                <pre class="json-content">{{ entry.cellsJson }}</pre>
              </details>
              <details class="nested-detail">
                <summary class="nested-summary">
                  <mat-icon class="expand-icon">chevron_right</mat-icon>
                  Previous Cells
                </summary>
                <pre class="json-content">{{ entry.previousCellsJson }}</pre>
              </details>
            </div>
          </details>
        }
      }
    </div>
  </details>

  <!-- Redo Stack Section -->
  <details class="history-section">
    <summary class="history-section-header">
      <mat-icon class="expand-icon">expand_more</mat-icon>
      <strong>Redo Stack</strong>
      <span class="count-badge">({{ redoStack.length }})</span>
    </summary>
    <div class="history-section-content">
      @if (redoStack.length === 0) {
        <div class="empty-state">No redo entries</div>
      } @else {
        @for (entry of redoStack; track entry.id) {
          <details class="history-entry">
            <summary class="history-entry-header">
              <mat-icon class="expand-icon">chevron_right</mat-icon>
              <span class="entry-index">#{{ entry.index }}</span>
              <span class="entry-type">{{ entry.operationType }}</span>
              <span class="entry-description">{{ entry.description }}</span>
              <span class="entry-time">{{ entry.timestampFormatted }}</span>
            </summary>
            <div class="history-entry-content">
              <div class="entry-detail">
                <span class="label">ID:</span>
                <code class="value">{{ entry.id }}</code>
              </div>
              <div class="entry-detail">
                <span class="label">Timestamp:</span>
                <span class="value">{{ entry.timestamp }}</span>
              </div>
              <div class="entry-detail">
                <span class="label">Affected Cells:</span>
                <span class="value">{{ entry.affectedCellCount }}</span>
              </div>
              @if (entry.affectedCellIds.length > 0) {
                <div class="entry-detail">
                  <span class="label">Cell IDs:</span>
                  <code class="value">{{ entry.affectedCellIds.join(', ') }}</code>
                </div>
              }
              @if (entry.userId) {
                <div class="entry-detail">
                  <span class="label">User ID:</span>
                  <code class="value">{{ entry.userId }}</code>
                </div>
              }
              @if (entry.operationId) {
                <div class="entry-detail">
                  <span class="label">Operation ID:</span>
                  <code class="value">{{ entry.operationId }}</code>
                </div>
              }
              @if (entry.metadata) {
                <details class="nested-detail">
                  <summary class="nested-summary">
                    <mat-icon class="expand-icon">chevron_right</mat-icon>
                    Metadata
                  </summary>
                  <pre class="json-content">{{ entry.metadata | json }}</pre>
                </details>
              }
              <details class="nested-detail">
                <summary class="nested-summary">
                  <mat-icon class="expand-icon">chevron_right</mat-icon>
                  Cells ({{ entry.affectedCellCount }})
                </summary>
                <pre class="json-content">{{ entry.cellsJson }}</pre>
              </details>
              <details class="nested-detail">
                <summary class="nested-summary">
                  <mat-icon class="expand-icon">chevron_right</mat-icon>
                  Previous Cells
                </summary>
                <pre class="json-content">{{ entry.previousCellsJson }}</pre>
              </details>
            </div>
          </details>
        }
      }
    </div>
  </details>
</div>

<div mat-dialog-actions align="end">
  <button mat-button (click)="onCopyToClipboard()" tabindex="1" aria-label="Copy full JSON to clipboard">
    <mat-icon>content_copy</mat-icon>
    Copy Full JSON
  </button>
  <button mat-button (click)="onClose()" tabindex="2" aria-label="Close">Close</button>
</div>

<h1 mat-dialog-title>{{ 'debugDialogs.historyDialog.title' | transloco }}</h1>

<div mat-dialog-content appScrollIndicator class="history-content">
  <!-- Summary Section -->
  <details class="history-section" open>
    <summary class="history-section-header">
      <mat-icon class="expand-icon">expand_more</mat-icon>
      <strong>{{ 'debugDialogs.historyDialog.summary' | transloco }}</strong>
    </summary>
    <div class="history-section-content">
      <div class="summary-grid">
        <div class="summary-item">
          <span class="label">{{ 'debugDialogs.historyDialog.canUndo' | transloco }}:</span>
          <span class="value">{{ summary.canUndo }}</span>
        </div>
        <div class="summary-item">
          <span class="label">{{ 'debugDialogs.historyDialog.canRedo' | transloco }}:</span>
          <span class="value">{{ summary.canRedo }}</span>
        </div>
        <div class="summary-item">
          <span class="label">{{ 'debugDialogs.historyDialog.undoStackSize' | transloco }}:</span>
          <span class="value">{{ summary.undoStackSize }}</span>
        </div>
        <div class="summary-item">
          <span class="label">{{ 'debugDialogs.historyDialog.redoStackSize' | transloco }}:</span>
          <span class="value">{{ summary.redoStackSize }}</span>
        </div>
        <div class="summary-item">
          <span class="label">{{ 'debugDialogs.historyDialog.maxStackSize' | transloco }}:</span>
          <span class="value">{{ summary.maxStackSize }}</span>
        </div>
        <div class="summary-item">
          <span class="label">{{ 'debugDialogs.historyDialog.currentIndex' | transloco }}:</span>
          <span class="value">{{ summary.currentIndex }}</span>
        </div>
      </div>
    </div>
  </details>

  <!-- Undo Stack Section -->
  <details class="history-section" [attr.open]="undoStack.length > 0 ? true : null">
    <summary class="history-section-header">
      <mat-icon class="expand-icon">expand_more</mat-icon>
      <strong>{{ 'debugDialogs.historyDialog.undoStack' | transloco }}</strong>
      <span class="count-badge">({{ undoStack.length }})</span>
    </summary>
    <div class="history-section-content">
      @if (undoStack.length === 0) {
        <div class="empty-state">{{ 'debugDialogs.historyDialog.noUndoEntries' | transloco }}</div>
      } @else {
        @for (entry of undoStack; track entry.id) {
          <details class="history-entry">
            <summary class="history-entry-header">
              <mat-icon class="expand-icon">chevron_right</mat-icon>
              <span class="entry-index">#{{ entry.index }}</span>
              <span class="entry-type">{{ entry.operationType }}</span>
              <span class="entry-description">{{ entry.description }}</span>
              <span class="entry-time">{{ entry.timestampFormatted }}</span>
            </summary>
            <div class="history-entry-content">
              <div class="entry-detail">
                <span class="label">{{ 'debugDialogs.historyDialog.id' | transloco }}:</span>
                <code class="value">{{ entry.id }}</code>
              </div>
              <div class="entry-detail">
                <span class="label">{{ 'debugDialogs.historyDialog.timestamp' | transloco }}:</span>
                <span class="value">{{ entry.timestamp }}</span>
              </div>
              <div class="entry-detail">
                <span class="label">{{ 'debugDialogs.common.affectedCells' | transloco }}:</span>
                <span class="value">{{ entry.affectedCellCount }}</span>
              </div>
              @if (entry.affectedCellIds.length > 0) {
                <div class="entry-detail">
                  <span class="label">{{ 'debugDialogs.common.cellIds' | transloco }}:</span>
                  <code class="value">{{ entry.affectedCellIds.join(', ') }}</code>
                </div>
              }
              @if (entry.userId) {
                <div class="entry-detail">
                  <span class="label">{{ 'debugDialogs.historyDialog.userId' | transloco }}:</span>
                  <code class="value">{{ entry.userId }}</code>
                </div>
              }
              @if (entry.operationId) {
                <div class="entry-detail">
                  <span class="label"
                    >{{ 'debugDialogs.historyDialog.operationId' | transloco }}:</span
                  >
                  <code class="value">{{ entry.operationId }}</code>
                </div>
              }
              @if (entry.metadata) {
                <details class="nested-detail">
                  <summary class="nested-summary">
                    <mat-icon class="expand-icon">chevron_right</mat-icon>
                    {{ 'common.metadata' | transloco }}
                  </summary>
                  <pre class="json-content">{{ entry.metadata | json }}</pre>
                </details>
              }
              <details class="nested-detail">
                <summary class="nested-summary">
                  <mat-icon class="expand-icon">chevron_right</mat-icon>
                  {{ 'debugDialogs.common.cells' | transloco }} ({{ entry.affectedCellCount }})
                </summary>
                <pre class="json-content">{{ entry.cellsJson }}</pre>
              </details>
              <details class="nested-detail">
                <summary class="nested-summary">
                  <mat-icon class="expand-icon">chevron_right</mat-icon>
                  {{ 'debugDialogs.historyDialog.previousCells' | transloco }}
                </summary>
                <pre class="json-content">{{ entry.previousCellsJson }}</pre>
              </details>
            </div>
          </details>
        }
      }
    </div>
  </details>

  <!-- Redo Stack Section -->
  <details class="history-section">
    <summary class="history-section-header">
      <mat-icon class="expand-icon">expand_more</mat-icon>
      <strong>{{ 'debugDialogs.historyDialog.redoStack' | transloco }}</strong>
      <span class="count-badge">({{ redoStack.length }})</span>
    </summary>
    <div class="history-section-content">
      @if (redoStack.length === 0) {
        <div class="empty-state">{{ 'debugDialogs.historyDialog.noRedoEntries' | transloco }}</div>
      } @else {
        @for (entry of redoStack; track entry.id) {
          <details class="history-entry">
            <summary class="history-entry-header">
              <mat-icon class="expand-icon">chevron_right</mat-icon>
              <span class="entry-index">#{{ entry.index }}</span>
              <span class="entry-type">{{ entry.operationType }}</span>
              <span class="entry-description">{{ entry.description }}</span>
              <span class="entry-time">{{ entry.timestampFormatted }}</span>
            </summary>
            <div class="history-entry-content">
              <div class="entry-detail">
                <span class="label">{{ 'debugDialogs.historyDialog.id' | transloco }}:</span>
                <code class="value">{{ entry.id }}</code>
              </div>
              <div class="entry-detail">
                <span class="label">{{ 'debugDialogs.historyDialog.timestamp' | transloco }}:</span>
                <span class="value">{{ entry.timestamp }}</span>
              </div>
              <div class="entry-detail">
                <span class="label">{{ 'debugDialogs.common.affectedCells' | transloco }}:</span>
                <span class="value">{{ entry.affectedCellCount }}</span>
              </div>
              @if (entry.affectedCellIds.length > 0) {
                <div class="entry-detail">
                  <span class="label">{{ 'debugDialogs.common.cellIds' | transloco }}:</span>
                  <code class="value">{{ entry.affectedCellIds.join(', ') }}</code>
                </div>
              }
              @if (entry.userId) {
                <div class="entry-detail">
                  <span class="label">{{ 'debugDialogs.historyDialog.userId' | transloco }}:</span>
                  <code class="value">{{ entry.userId }}</code>
                </div>
              }
              @if (entry.operationId) {
                <div class="entry-detail">
                  <span class="label"
                    >{{ 'debugDialogs.historyDialog.operationId' | transloco }}:</span
                  >
                  <code class="value">{{ entry.operationId }}</code>
                </div>
              }
              @if (entry.metadata) {
                <details class="nested-detail">
                  <summary class="nested-summary">
                    <mat-icon class="expand-icon">chevron_right</mat-icon>
                    {{ 'common.metadata' | transloco }}
                  </summary>
                  <pre class="json-content">{{ entry.metadata | json }}</pre>
                </details>
              }
              <details class="nested-detail">
                <summary class="nested-summary">
                  <mat-icon class="expand-icon">chevron_right</mat-icon>
                  {{ 'debugDialogs.common.cells' | transloco }} ({{ entry.affectedCellCount }})
                </summary>
                <pre class="json-content">{{ entry.cellsJson }}</pre>
              </details>
              <details class="nested-detail">
                <summary class="nested-summary">
                  <mat-icon class="expand-icon">chevron_right</mat-icon>
                  {{ 'debugDialogs.historyDialog.previousCells' | transloco }}
                </summary>
                <pre class="json-content">{{ entry.previousCellsJson }}</pre>
              </details>
            </div>
          </details>
        }
      }
    </div>
  </details>
</div>

<div mat-dialog-actions align="end">
  <button
    mat-button
    (click)="onClearHistory()"
    tabindex="1"
    [attr.aria-label]="'debugDialogs.historyDialog.clearHistory' | transloco"
  >
    <mat-icon>delete_sweep</mat-icon>
    {{ 'debugDialogs.historyDialog.clearHistory' | transloco }}
  </button>
  <button
    mat-button
    (click)="onCopyToClipboard()"
    tabindex="2"
    [attr.aria-label]="'debugDialogs.common.copyFullJson' | transloco"
  >
    <mat-icon>content_copy</mat-icon>
    {{ 'debugDialogs.common.copyFullJson' | transloco }}
  </button>
  <button
    mat-button
    (click)="onClose()"
    tabindex="3"
    [attr.aria-label]="'common.close' | transloco"
  >
    {{ 'common.close' | transloco }}
  </button>
</div>

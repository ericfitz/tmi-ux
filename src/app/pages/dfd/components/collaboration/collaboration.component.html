<div class="collaboration-container">
  <!-- WebSocket Connection Status Icon -->
  <span
    [matTooltip]="getWebSocketStatusTooltip()"
    matTooltipPosition="below"
    matTooltipClass="multiline-tooltip"
    style="display: inline-block; margin-right: 8px"
  >
    <button mat-icon-button [class]="getWebSocketStatusIconClass()" disabled>
      <mat-icon fontSet="material-symbols-outlined">{{ getWebSocketStatusIcon() }}</mat-icon>
    </button>
  </span>

  <!-- Main collaboration button with badge showing number of users when active -->
  <button
    mat-icon-button
    [color]="getCollaborationButtonColor()"
    [matBadge]="collaborationUsers.length || null"
    matBadgeColor="accent"
    [matTooltip]="getCollaborationButtonTooltip()"
    [matMenuTriggerFor]="collaborationMenu"
  >
    <mat-icon
      fontSet="material-symbols-outlined"
      fontWeight="100"
      style="font-variation-settings: 'FILL' 0"
      [class.active]="isCollaborating"
      [class.session-available]="existingSessionAvailable && !isCollaborating"
    >
      group
    </mat-icon>
  </button>

  <!-- Collaboration menu -->
  <mat-menu #collaborationMenu="matMenu" class="collaboration-menu">
    <div class="menu-header">
      <h3>{{ 'collaboration.title' | transloco }}</h3>
    </div>

    <!-- Toggle collaboration button -->
    <div class="collaboration-action">
      <button
        mat-flat-button
        [color]="isCollaborating ? 'warn' : 'success'"
        (click)="toggleCollaboration()"
      >
        <mat-icon
          fontSet="material-symbols-outlined"
          fontWeight="100"
          style="font-variation-settings: 'FILL' 0"
        >
          {{ isCollaborating ? 'stop' : 'play_arrow' }}
        </mat-icon>
        <ng-container *ngIf="!isCollaborating && !existingSessionAvailable">
          {{ 'collaboration.startCollaboration' | transloco }}
        </ng-container>
        <ng-container *ngIf="!isCollaborating && existingSessionAvailable">
          {{ 'collaboration.joinSession' | transloco }}
        </ng-container>
        <ng-container *ngIf="isCollaborating && isCurrentUserHost()">
          {{ 'collaboration.endCollaboration' | transloco }}
        </ng-container>
        <ng-container *ngIf="isCollaborating && !isCurrentUserHost()">
          {{ 'collaboration.leaveSession' | transloco }}
        </ng-container>
      </button>
    </div>

    <!-- Copy Link section (only visible when collaborating) -->
    <div *ngIf="isCollaborating" class="copy-link-section">
      <div class="copy-link-header">
        <h4>{{ 'collaboration.shareLinkHeader' | transloco }}</h4>
      </div>
      <div class="copy-link-action">
        <button mat-flat-button color="primary" (click)="copyLinkToClipboard()">
          <mat-icon fontSet="material-symbols-outlined" fontWeight="100">content_copy</mat-icon>
          {{ 'collaboration.copyLink' | transloco }}
        </button>
      </div>
    </div>

    <!-- Users list (visible when there are participants) -->
    <div *ngIf="collaborationUsers.length > 0" class="users-section">
      <div class="users-header">
        <h4>{{ 'collaboration.collaboratorsHeader' | transloco }}</h4>
      </div>
      <div class="users-list">
        <div *ngFor="let user of collaborationUsers" class="user-item">
          <!-- Column 1: User Type -->
          <div class="user-type-column">
            <mat-icon
              fontSet="material-symbols-outlined"
              fontWeight="100"
              style="font-variation-settings: 'FILL' 0"
              [matTooltip]="
                user.isHost
                  ? ('common.sessionRoles.host' | transloco)
                  : ('common.sessionRoles.participant' | transloco)
              "
            >
              {{ user.isHost ? 'admin_panel_settings' : 'person' }}
            </mat-icon>
          </div>

          <!-- Column 2: Permissions -->
          <div class="permissions-column">
            <mat-icon
              fontSet="material-symbols-outlined"
              fontWeight="100"
              style="font-variation-settings: 'FILL' 0"
              [matTooltip]="
                user.permission === 'writer'
                  ? ('common.roles.writer' | transloco)
                  : ('common.roles.reader' | transloco)
              "
            >
              {{ user.permission === 'writer' ? 'edit' : 'edit_off' }}
            </mat-icon>
          </div>

          <!-- Column 3: Username -->
          <div class="username-column" [matTooltip]="user.email">
            {{ user.name }}
          </div>

          <!-- Column 4: Presenter Control -->
          <div class="presenter-column">
            <!-- Host as Presenter -->
            <mat-icon
              *ngIf="user.isHost && user.isPresenter"
              fontSet="material-symbols-outlined"
              fontWeight="100"
              style="font-variation-settings: 'FILL' 0"
              [matTooltip]="'common.sessionRoles.presenter' | transloco"
              class="presenter-icon"
            >
              podium
            </mat-icon>

            <!-- Host not Presenter -->
            <mat-icon
              *ngIf="user.isHost && !user.isPresenter"
              fontSet="material-symbols-outlined"
              fontWeight="100"
              style="font-variation-settings: 'FILL' 0"
              class="presenter-icon inactive"
            >
              podium
            </mat-icon>

            <!-- Participant as Presenter - Can take back presenter -->
            <button
              *ngIf="!user.isHost && user.isPresenter && isCurrentUserHost()"
              mat-icon-button
              (click)="takeBackPresenterPrivileges()"
              [matTooltip]="'collaboration.takeBackPresenter' | transloco"
              class="presenter-button"
            >
              <mat-icon
                fontSet="material-symbols-outlined"
                fontWeight="100"
                style="font-variation-settings: 'FILL' 0"
                class="presenter-icon with-overlay"
              >
                podium
              </mat-icon>
              <mat-icon class="overlay-icon">close</mat-icon>
            </button>

            <!-- Participant not Presenter - Show state-based button -->
            <ng-container *ngIf="!user.isHost && !user.isPresenter">
              <!-- Hand Down State -->
              <button
                *ngIf="
                  isCurrentUser(user.id) &&
                  (!user.presenterRequestState || user.presenterRequestState === 'hand_down')
                "
                mat-icon-button
                (click)="requestPresenterPrivileges()"
                [matTooltip]="'collaboration.requestPresenter' | transloco"
                class="presenter-button"
              >
                <mat-icon
                  fontSet="material-symbols-outlined"
                  fontWeight="100"
                  style="font-variation-settings: 'FILL' 0"
                >
                  person_raised_hand
                </mat-icon>
              </button>

              <!-- Hand Raised State -->
              <mat-icon
                *ngIf="isCurrentUser(user.id) && user.presenterRequestState === 'hand_raised'"
                fontSet="material-symbols-outlined"
                fontWeight="100"
                style="font-variation-settings: 'FILL' 0"
                [matTooltip]="'collaboration.presenterModeRequested' | transloco"
                class="presenter-icon hand-raised"
              >
                person_raised_hand
              </mat-icon>

              <!-- Other users - no button -->
              <div *ngIf="!isCurrentUser(user.id)" class="presenter-placeholder"></div>
            </ng-container>
          </div>

          <!-- Column 5: Remove User -->
          <div class="remove-column">
            <button
              *ngIf="!user.isHost && isCurrentUserHost()"
              mat-icon-button
              color="warn"
              (click)="removeUser(user.id)"
              [matTooltip]="'collaboration.removeFromSession' | transloco"
            >
              <mat-icon
                fontSet="material-symbols-outlined"
                fontWeight="100"
                style="font-variation-settings: 'FILL' 0"
              >
                person_remove
              </mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>
  </mat-menu>
</div>

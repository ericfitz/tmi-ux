<div class="header-row dashboard-title">
  <h1 class="page-title" [transloco]="'threatModels.dashboard'">Dashboard</h1>
</div>

<div class="tm-container">
  <div class="header-row">
    <h2 class="section-title" [transloco]="'threatModels.yourThreatModels'">Your Threat Models</h2>
    <div class="header-actions">
      <button
        mat-icon-button
        color="primary"
        (click)="toggleViewMode()"
        [matTooltip]="
          dashboardListView
            ? ('dashboard.viewAsCards' | transloco)
            : ('dashboard.viewAsList' | transloco)
        "
      >
        <mat-icon>{{ dashboardListView ? 'view_module' : 'list_alt' }}</mat-icon>
      </button>
      <button
        mat-icon-button
        color="primary"
        (click)="import()"
        [matTooltip]="'threatModels.tooltips.import' | transloco"
      >
        <mat-icon>file_open</mat-icon>
      </button>
      <button
        mat-icon-button
        color="primary"
        (click)="createThreatModel()"
        [matTooltip]="'common.create' | transloco"
      >
        <mat-icon>add</mat-icon>
      </button>
    </div>
  </div>

  <!-- Filter field -->
  <mat-form-field class="filter-field" appearance="outline">
    <mat-label [transloco]="'dashboard.filterLabel'">Filter Threat Models</mat-label>
    <input
      matInput
      [value]="filterText"
      (input)="onFilterChange($any($event.target).value)"
      [placeholder]="'dashboard.filterPlaceholder' | transloco"
    />
    <mat-icon matPrefix>search</mat-icon>
    @if (filterText) {
      <button matSuffix mat-icon-button (click)="clearFilter()" aria-label="Clear filter">
        <mat-icon>close</mat-icon>
      </button>
    }
  </mat-form-field>

  <div class="threat-models-list">
    @if (isLoadingThreatModels) {
      <div class="loading-container">
        <div class="spinner"></div>
      </div>
    }

    <!-- Card View -->
    @if (!dashboardListView && !isLoadingThreatModels) {
      <div class="cards-grid">
        <mat-card
          *ngFor="let threatModel of filteredThreatModels"
          class="threat-model-card"
          [class.has-active-session]="hasActiveSessions(threatModel.id)"
          (click)="openThreatModel(threatModel.id)"
        >
          <mat-card-content>
            <div class="threat-model-info">
              <mat-icon class="threat-model-icon">security</mat-icon>
              <div class="threat-model-details">
                <h3
                  class="threat-model-title"
                  [matTooltip]="threatModel.name"
                  matTooltipShowDelay="500"
                >
                  {{ threatModel.name }}
                </h3>
                @if (threatModel.description) {
                  <p
                    class="threat-model-description"
                    [matTooltip]="threatModel.description"
                    matTooltipShowDelay="500"
                  >
                    {{ threatModel.description }}
                  </p>
                }
                <p class="threat-model-date">
                  <span class="date-label">{{ 'common.lastModified' | transloco }}:</span>
                  {{ formatDate(threatModel.modified_at) }}
                </p>
                <p class="threat-model-status">
                  <span class="status-label">{{ 'common.status' | transloco }}:</span>
                  {{
                    threatModel.status
                      ? ('threatModels.status.' + threatModel.status | transloco)
                      : '—'
                  }}
                </p>
                <p class="threat-model-status-updated">
                  <span class="status-label"
                    >{{ 'threatModels.statusLastUpdated' | transloco }}:</span
                  >
                  {{ threatModel.status_updated ? formatDate(threatModel.status_updated) : '—' }}
                </p>

                @if (hasActiveSessions(threatModel.id)) {
                  <div class="collaboration-info" (click)="$event.stopPropagation()">
                    @for (
                      session of getSessionsForTm(threatModel.id);
                      track session.id;
                      let last = $last
                    ) {
                      <div class="collaboration-session-entry">
                        <p class="collab-detail">
                          <mat-icon>account_tree</mat-icon> {{ session.diagramName }}
                        </p>
                        <p class="collab-detail">
                          <mat-icon>person</mat-icon>
                          {{ 'collaboration.hostedBy' | transloco }}&nbsp;<app-user-display
                            [user]="session.host"
                            fallback="—"
                          />
                        </p>
                        <p class="collab-detail">
                          <mat-icon>schedule</mat-icon>
                          {{ 'collaboration.sessionStarted' | transloco }}
                          {{ formatSessionTime(session.startedAt) }}
                        </p>
                        <p class="collab-detail">
                          <mat-icon>group</mat-icon>
                          {{
                            'collaboration.activeUsers' | transloco: { count: session.activeUsers }
                          }}
                        </p>
                        <button
                          mat-stroked-button
                          color="primary"
                          class="join-session-button"
                          (click)="openCollaborationSession(session.diagramId)"
                          [matTooltip]="'collaboration.joinSession' | transloco"
                        >
                          <mat-icon>login</mat-icon>
                          {{ 'collaboration.joinSession' | transloco }}
                        </button>
                      </div>
                      @if (!last) {
                        <mat-divider></mat-divider>
                      }
                    }
                  </div>
                } @else {
                  <div class="threat-model-stats">
                    <div class="stats-row">
                      <span class="stat">
                        <mat-icon
                          fontSet="material-symbols-outlined"
                          fontWeight="100"
                          style="font-variation-settings: 'FILL' 0"
                          >diamond</mat-icon
                        >
                        {{ threatModel.asset_count }} {{ 'common.objectTypes.assets' | transloco }}
                      </span>
                      <span class="stat">
                        <mat-icon
                          fontSet="material-symbols-outlined"
                          fontWeight="100"
                          style="font-variation-settings: 'FILL' 0"
                          class="skull-icon"
                          >skull</mat-icon
                        >
                        {{ threatModel.threat_count }}
                        {{ 'common.objectTypes.threats' | transloco }}
                      </span>
                    </div>
                    <div class="stats-row">
                      <span class="stat">
                        <mat-icon>account_tree</mat-icon>
                        {{ threatModel.diagram_count }}
                        {{ 'threatModels.diagrams' | transloco }}
                      </span>
                      <span class="stat">
                        <mat-icon>note</mat-icon>
                        {{ threatModel.note_count }} {{ 'common.objectTypes.notes' | transloco }}
                      </span>
                    </div>
                    <div class="stats-row">
                      <span class="stat">
                        <mat-icon>description</mat-icon>
                        {{ threatModel.document_count }}
                        {{ 'common.objectTypes.documents' | transloco }}
                      </span>
                      <span class="stat">
                        <mat-icon>code</mat-icon>
                        {{ threatModel.repo_count }} {{ 'threatModels.sourcesCount' | transloco }}
                      </span>
                    </div>
                  </div>
                }
              </div>
            </div>
            <button
              mat-icon-button
              color="warn"
              class="delete-button"
              (click)="deleteThreatModel(threatModel.id, $event)"
              [matTooltip]="'common.delete' | transloco"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </mat-card-content>
        </mat-card>
      </div>
    }

    <!-- Table/List View -->
    @if (dashboardListView && !isLoadingThreatModels) {
      <div class="table-container">
        <table
          mat-table
          [dataSource]="dataSource"
          matSort
          multiTemplateDataRows
          class="threat-models-table"
        >
          <!-- Collaboration Indicator Column -->
          <ng-container matColumnDef="collaborationIndicator">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let tm">
              @if (hasActiveSessions(tm.id)) {
                <button
                  mat-icon-button
                  class="collab-indicator-button"
                  (click)="toggleRowExpansion(tm.id, $event)"
                  [matTooltip]="'collaboration.joinSession' | transloco"
                >
                  <mat-icon class="collab-indicator-icon">groups</mat-icon>
                </button>
              }
            </td>
          </ng-container>

          <!-- Name Column -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              {{ 'dashboard.tableHeaders.name' | transloco }}
            </th>
            <td mat-cell *matCellDef="let tm">
              <span class="tm-name" [matTooltip]="tm.name">{{ tm.name }}</span>
            </td>
          </ng-container>

          <!-- Last Modified Column -->
          <ng-container matColumnDef="lastModified">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              {{ 'dashboard.tableHeaders.lastModified' | transloco }}
            </th>
            <td mat-cell *matCellDef="let tm">
              {{ formatDate(tm.modified_at) }}
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              {{ 'dashboard.tableHeaders.status' | transloco }}
            </th>
            <td mat-cell *matCellDef="let tm">
              {{ tm.status ? ('threatModels.status.' + tm.status | transloco) : '—' }}
            </td>
          </ng-container>

          <!-- Status Last Changed Column -->
          <ng-container matColumnDef="statusLastChanged">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              {{ 'dashboard.tableHeaders.statusLastChanged' | transloco }}
            </th>
            <td mat-cell *matCellDef="let tm">
              {{ tm.status_updated ? formatDate(tm.status_updated) : '—' }}
            </td>
          </ng-container>

          <!-- Owner Column -->
          <ng-container matColumnDef="owner">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              {{ 'dashboard.tableHeaders.owner' | transloco }}
            </th>
            <td mat-cell *matCellDef="let tm">
              <app-user-display [user]="tm.owner" fallback="—" />
            </td>
          </ng-container>

          <!-- Created Column -->
          <ng-container matColumnDef="created">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              {{ 'dashboard.tableHeaders.created' | transloco }}
            </th>
            <td mat-cell *matCellDef="let tm">
              {{ formatDate(tm.created_at) }}
            </td>
          </ng-container>

          <!-- Actions Column (not sortable) -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>
              {{ 'dashboard.tableHeaders.actions' | transloco }}
            </th>
            <td mat-cell *matCellDef="let tm">
              <button
                mat-icon-button
                color="warn"
                (click)="deleteThreatModel(tm.id, $event)"
                [matTooltip]="'common.delete' | transloco"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <!-- Expandable Detail Row -->
          <ng-container matColumnDef="expandedDetail">
            <td mat-cell *matCellDef="let tm" [attr.colspan]="displayedColumns.length">
              @if (expandedTmId === tm.id && hasActiveSessions(tm.id)) {
                <div class="expanded-session-detail" [@detailExpand]>
                  @for (session of getSessionsForTm(tm.id); track session.id; let last = $last) {
                    <div class="session-detail-content">
                      <p class="collab-detail">
                        <mat-icon>account_tree</mat-icon> {{ session.diagramName }}
                      </p>
                      <p class="collab-detail">
                        <mat-icon>person</mat-icon>
                        {{ 'collaboration.hostedBy' | transloco }}&nbsp;<app-user-display
                          [user]="session.host"
                          fallback="—"
                        />
                      </p>
                      <p class="collab-detail">
                        <mat-icon>schedule</mat-icon>
                        {{ 'collaboration.sessionStarted' | transloco }}
                        {{ formatSessionTime(session.startedAt) }}
                      </p>
                      <p class="collab-detail">
                        <mat-icon>group</mat-icon>
                        {{
                          'collaboration.activeUsers' | transloco: { count: session.activeUsers }
                        }}
                      </p>
                      <button
                        mat-stroked-button
                        color="primary"
                        class="join-session-button"
                        (click)="
                          openCollaborationSession(session.diagramId); $event.stopPropagation()
                        "
                      >
                        <mat-icon>login</mat-icon>
                        {{ 'collaboration.joinSession' | transloco }}
                      </button>
                    </div>
                    @if (!last) {
                      <mat-divider></mat-divider>
                    }
                  }
                </div>
              }
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns"
            class="clickable-row"
            (click)="openThreatModel(row.id)"
            [matTooltip]="row.description || ''"
            matTooltipShowDelay="500"
          ></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: ['expandedDetail']"
            class="detail-row"
            [class.expanded]="expandedTmId === row.id"
          ></tr>
        </table>
      </div>
    }

    <!-- Empty state: no threat models at all -->
    @if (!isLoadingThreatModels && threatModels.length === 0) {
      <div class="no-threat-models">
        <mat-icon class="empty-icon">sentiment_dissatisfied</mat-icon>
        <p [transloco]="'threatModels.noItemsMessage'">You don't have any threat models yet.</p>
        <button mat-raised-button color="primary" (click)="createThreatModel()">
          <span [transloco]="'threatModels.createFirstButton'">Create your first threat model</span>
        </button>
      </div>
    }

    <!-- Empty state: no matching threat models after filtering -->
    @if (!isLoadingThreatModels && threatModels.length > 0 && filteredThreatModels.length === 0) {
      <div class="no-threat-models">
        <mat-icon class="empty-icon">search_off</mat-icon>
        <p [transloco]="'dashboard.noMatchingThreatModels'">No threat models match your filter.</p>
        <button mat-button (click)="clearFilter()">
          {{ 'dashboard.clearFilter' | transloco }}
        </button>
      </div>
    }

    <!-- Paginator (hidden when all items fit on one page) -->
    @if (!isLoadingThreatModels && totalItems > pageSize) {
      <mat-paginator
        [length]="totalItems"
        [pageSize]="pageSize"
        [pageIndex]="pageIndex"
        [pageSizeOptions]="pageSizeOptions"
        (page)="onPageChange($event)"
        showFirstLastButtons
        [attr.aria-label]="'pagination.ariaLabel' | transloco"
      >
      </mat-paginator>
    }
  </div>
</div>

<!-- Import overlay spinner -->
@if (isImporting) {
  <div class="import-overlay">
    <div class="import-spinner-container">
      <div class="spinner"></div>
      <p class="import-message">{{ 'threatModels.importing' | transloco }}</p>
    </div>
  </div>
}

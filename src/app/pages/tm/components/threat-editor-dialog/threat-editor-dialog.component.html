<h2 mat-dialog-title>
  {{ dialogTitle | transloco }}
</h2>
<mat-dialog-content [dir]="currentDirection" appScrollIndicator>
  <!-- Force translation update -->
  <div style="display: none">{{ 'common.threatName' | transloco }}</div>
  <!-- Threat ID and timestamps section -->
  @if (data.threat) {
    <div class="info-section-vertical" [dir]="currentDirection">
      <div class="info-field">
        <span class="info-label">{{ 'common.threatId' | transloco }}:</span>
        <span class="info-value">{{ data.threat.id }}</span>
        <button
          mat-icon-button
          class="copy-button"
          (click)="copyToClipboard(data.threat.id)"
          matTooltip="{{ 'common.copyToClipboard' | transloco }}"
          [attr.aria-label]="'common.copyToClipboard' | transloco"
        >
          <mat-icon>content_copy</mat-icon>
        </button>
      </div>
      <div class="info-field dates-row">
        <div class="date-field">
          <span class="info-label">{{ 'common.created' | transloco }}:</span>
          <span class="info-value">{{
            data.threat.created_at | date: 'short' : undefined : currentLocale
          }}</span>
        </div>
        <div class="date-field">
          <span class="info-label">{{ 'common.lastModified' | transloco }}:</span>
          <span class="info-value">{{
            data.threat.modified_at | date: 'short' : undefined : currentLocale
          }}</span>
        </div>
      </div>
    </div>
  }

  <form [formGroup]="threatForm" class="dialog-form" [dir]="currentDirection">
    <div class="form-field-container">
      <mat-form-field appearance="outline" class="full-width" floatLabel="always">
        <mat-label>{{ 'common.threatName' | transloco }}</mat-label>
        <input matInput formControlName="name" tabindex="1" />
        @if (threatForm.get('name')?.hasError('required')) {
          <mat-error>
            {{ 'common.validation.required' | transloco }}
          </mat-error>
        }

        @if (threatForm.get('name')?.hasError('maxlength')) {
          <mat-error>
            {{ 'common.validation.maxLength' | transloco: { max: 100 } }}
          </mat-error>
        }
      </mat-form-field>
    </div>

    <div class="form-field-container">
      <mat-form-field appearance="outline" class="full-width" floatLabel="always">
        <mat-label>{{ 'common.threatDescription' | transloco }}</mat-label>
        <textarea
          matInput
          formControlName="description"
          rows="3"
          tabindex="2"
          placeholder="{{ 'common.threatDescriptionPlaceholder' | transloco }}"
        ></textarea>
        @if (threatForm.get('description')?.hasError('maxlength')) {
          <mat-error>
            {{ 'common.validation.maxLength' | transloco: { max: 500 } }}
          </mat-error>
        }
      </mat-form-field>
    </div>

    <!-- Threat Type field - on its own row -->
    <div class="form-field-row">
      <mat-form-field appearance="outline" class="full-width" floatLabel="always">
        <mat-label>{{ 'common.threatType' | transloco }}</mat-label>
        <mat-select formControlName="threat_type" tabindex="3">
          <mat-option *ngFor="let threatType of threatTypeOptions" [value]="threatType">
            {{ threatType }}
          </mat-option>
        </mat-select>
        @if (threatForm.get('threat_type')?.hasError('required')) {
          <mat-error>
            {{ 'common.validation.required' | transloco }}
          </mat-error>
        }
      </mat-form-field>
    </div>

    <!-- Severity, Score, Priority row -->
    <div class="form-field-row three-columns">
      <!-- Severity field -->
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>{{ 'common.severity' | transloco }}</mat-label>
        <mat-select formControlName="severity" tabindex="4">
          <mat-option value="Unknown">{{ 'common.severityUnknown' | transloco }}</mat-option>
          <mat-option value="None">{{ 'common.severityNone' | transloco }}</mat-option>
          <mat-option value="Low">{{ 'common.severityLow' | transloco }}</mat-option>
          <mat-option value="Medium">{{ 'common.severityMedium' | transloco }}</mat-option>
          <mat-option value="High">{{ 'common.severityHigh' | transloco }}</mat-option>
          <mat-option value="Critical">{{ 'common.severityCritical' | transloco }}</mat-option>
        </mat-select>
        @if (threatForm.get('severity')?.hasError('required')) {
          <mat-error>
            {{ 'common.validation.required' | transloco }}
          </mat-error>
        }
      </mat-form-field>

      <!-- Score field -->
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>{{ 'common.score' | transloco }}</mat-label>
        <input
          matInput
          type="number"
          formControlName="score"
          min="0"
          max="10"
          step="0.1"
          tabindex="5"
        />
      </mat-form-field>

      <!-- Priority field -->
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>{{ 'common.priority' | transloco }}</mat-label>
        <input matInput formControlName="priority" tabindex="6" />
      </mat-form-field>
    </div>

    <!-- Issue URI field - on its own row -->
    <div class="form-field-row">
      <!-- Edit mode: Toggle between form input and hyperlink display -->
      @if (!isViewOnly) {
        <div class="issue-uri-container">
          <mat-form-field appearance="outline" class="issue-uri-field" floatLabel="always">
            <mat-label>{{ 'common.issueUri' | transloco }}</mat-label>

            <!-- Use ng-container with if-else to ensure exactly one control is always present -->
            @if (shouldShowIssueUriHyperlink()) {
              <ng-container>
                <input
                  matInput
                  readonly
                  [value]="initialIssueUriValue"
                  class="uri-view-content"
                  (click)="openUriInNewTab(initialIssueUriValue)"
                  style="cursor: pointer; color: #1976d2; text-decoration: underline"
                />
              </ng-container>
            } @else {
              <input
                matInput
                formControlName="issue_uri"
                type="url"
                tabindex="7"
                (blur)="onIssueUriBlur()"
              />
            }
          </mat-form-field>

          <!-- Edit button outside the form field -->
          @if (shouldShowIssueUriHyperlink()) {
            <button
              mat-icon-button
              class="external-edit-button"
              (click)="editIssueUri()"
              [matTooltip]="'common.edit' | transloco"
              [attr.aria-label]="'common.edit' | transloco"
              tabindex="8"
            >
              <mat-icon>edit</mat-icon>
            </button>
          }
        </div>
      }

      <!-- View-only mode: Show only hyperlink if URI exists -->
      @if (isViewOnly && data.threat?.issue_uri) {
        <div class="view-only-uri">
          <span class="uri-label">{{ 'common.issueUri' | transloco }}:</span>
          <a
            [href]="data.threat?.issue_uri"
            target="_blank"
            rel="noopener noreferrer"
            class="issue-uri-link"
          >
            {{ data.threat?.issue_uri }}
          </a>
        </div>
      }
    </div>

    <!-- Status and Mitigated row -->
    <div class="form-field-row two-columns">
      <!-- Status field -->
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>{{ 'common.status' | transloco }}</mat-label>
        <input matInput formControlName="status" tabindex="9" />
      </mat-form-field>

      <!-- Mitigated field -->
      <div class="checkbox-field">
        <mat-checkbox formControlName="mitigated" tabindex="10">
          {{ 'common.mitigated' | transloco }}
        </mat-checkbox>
      </div>
    </div>

    <!-- Diagram ID field - on its own row -->
    <div class="form-field-row">
      <mat-form-field appearance="outline" class="full-width" floatLabel="always">
        <mat-label>{{ 'common.diagramId' | transloco }}</mat-label>
        <mat-select formControlName="diagram_id" tabindex="11">
          <mat-option *ngFor="let diagram of diagramOptions" [value]="diagram.id">
            {{
              diagram.id === NOT_ASSOCIATED_VALUE
                ? diagram.name
                : diagram.id + ' (' + diagram.name + ')'
            }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Cell ID field - on its own row -->
    <div class="form-field-row">
      <mat-form-field appearance="outline" class="full-width" floatLabel="always">
        <mat-label>{{ 'common.cellId' | transloco }}</mat-label>
        <mat-select formControlName="cell_id" tabindex="12">
          <mat-option *ngFor="let cell of cellOptions" [value]="cell.id">
            {{ cell.id === NOT_ASSOCIATED_VALUE ? cell.label : cell.id + ' (' + cell.label + ')' }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </form>
</mat-dialog-content>
<mat-dialog-actions align="end">
  <button
    mat-button
    (click)="onCancel()"
    tabindex="13"
    [attr.aria-label]="'common.cancel' | transloco"
  >
    {{ 'common.cancel' | transloco }}
  </button>
  @if (!isViewOnly) {
    <button
      mat-raised-button
      color="primary"
      [disabled]="threatForm.invalid"
      (click)="onSubmit()"
      tabindex="14"
      [attr.aria-label]="'common.save' | transloco"
    >
      {{ 'common.save' | transloco }}
    </button>
  }

  @if (isViewOnly) {
    <button
      mat-raised-button
      color="primary"
      (click)="onCancel()"
      tabindex="13"
      [attr.aria-label]="'common.close' | transloco"
    >
      {{ 'common.close' | transloco }}
    </button>
  }
</mat-dialog-actions>

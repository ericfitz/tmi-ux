<div class="tm-edit-container">
  <div class="header-row">
    <h1 class="page-title">
      @if (isNewThreatModel) {
        {{ 'threatModels.newThreatModel' | transloco }}
      } @else {
        <span class="title-prefix">{{ 'threatModels.threatModelPrefix' | transloco }}:</span>
        {{ ' ' }}
        <span class="title-name">{{ threatModel?.name }}</span>
      }
      @if (!canEdit && !isNewThreatModel) {
        <mat-icon
          class="read-only-indicator"
          color="warn"
          [matTooltip]="'common.readOnlyTooltip' | transloco"
          [attr.aria-label]="'common.readOnly' | transloco"
          >edit_off</mat-icon
        >
      }
    </h1>
  </div>

  @if (threatModel) {
    <div class="content-container">
      <mat-card class="details-card">
        <mat-card-header>
          <mat-card-title [transloco]="'threatModels.details'">Threat Model Details</mat-card-title>
          <div class="header-actions">
            <button
              mat-icon-button
              color="primary"
              (click)="downloadToDesktop()"
              [matTooltip]="'threatModels.export' | transloco"
              [attr.aria-label]="'threatModels.export' | transloco"
            >
              <mat-icon>file_download</mat-icon>
            </button>
            @if (canEdit) {
              <button
                mat-icon-button
                color="primary"
                [matMenuTriggerFor]="detailsAddonsMenu"
                [matTooltip]="'common.addons' | transloco"
                [attr.aria-label]="'common.addons' | transloco"
              >
                <mat-icon>extension</mat-icon>
              </button>
            }
            <button
              mat-icon-button
              color="primary"
              (click)="openReport()"
              [matTooltip]="'common.objectTypes.report' | transloco"
              [attr.aria-label]="'common.objectTypes.report' | transloco"
            >
              <mat-icon fontSet="material-symbols-outlined">assignment</mat-icon>
            </button>
            <button
              mat-icon-button
              color="primary"
              (click)="openMetadataDialog()"
              [matTooltip]="'common.manageMetadata' | transloco"
              [attr.aria-label]="'common.manageMetadata' | transloco"
            >
              <mat-icon>list</mat-icon>
            </button>
            <button
              mat-icon-button
              color="primary"
              (click)="openPermissionsDialog()"
              [matTooltip]="'threatModels.permissionsTooltip' | transloco"
              [attr.aria-label]="'common.permissions' | transloco"
            >
              <mat-icon>lock</mat-icon>
            </button>
            <button
              mat-icon-button
              color="warn"
              (click)="cancel()"
              [matTooltip]="'common.close' | transloco"
              [attr.aria-label]="'common.close' | transloco"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </mat-card-header>
        <mat-card-content>
          <!-- Threat Model metadata section -->
          <div class="info-section" [dir]="currentDirection">
            <!-- First row: Last Modified, Created By, Created (only for existing models) -->
            @if (threatModel && !isNewThreatModel) {
              <div class="info-row info-row-three-col">
                <div class="info-field">
                  <span class="info-label">{{ 'common.lastModified' | transloco }}:</span>
                  <span class="info-value">{{
                    threatModel.modified_at | date: 'short' : undefined : currentLocale
                  }}</span>
                </div>
                <div class="info-field">
                  <span class="info-label">{{ 'threatModels.createdBy' | transloco }}:</span>
                  <span class="info-value"
                    ><app-user-display [user]="threatModel.created_by"
                  /></span>
                </div>
                <div class="info-field">
                  <span class="info-label">{{ 'threatModels.created' | transloco }}:</span>
                  <span class="info-value">{{
                    threatModel.created_at | date: 'short' : undefined : currentLocale
                  }}</span>
                </div>
              </div>
            }

            <!-- Status row: Status dropdown and Status Last Updated (always visible) -->
            <div class="info-row info-row-status" [formGroup]="threatModelForm">
              <div class="info-field">
                @if (canEdit) {
                  <mat-form-field appearance="outline" class="status-dropdown">
                    <mat-label>{{ 'common.status' | transloco }}</mat-label>
                    <mat-select formControlName="status">
                      <mat-option [value]="null">{{ 'common.none' | transloco }}</mat-option>
                      @for (option of statusOptions; track option.key) {
                        <mat-option
                          [value]="option.key"
                          [matTooltip]="
                            'threatModels.status.' + option.key + '.tooltip' | transloco
                          "
                        >
                          {{ 'threatModels.status.' + option.key | transloco }}
                        </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                } @else {
                  <span class="info-label">{{ 'common.status' | transloco }}:</span>
                  @if (threatModelForm.get('status')?.value; as statusValue) {
                    <span class="info-value">{{
                      'threatModels.status.' + statusValue | transloco
                    }}</span>
                  } @else {
                    <span class="info-value">—</span>
                  }
                }
              </div>
              @if (threatModel && !isNewThreatModel) {
                <div class="info-field">
                  <span class="info-label"
                    >{{ 'threatModels.statusLastUpdated' | transloco }}:</span
                  >
                  <span class="info-value">{{
                    threatModel.status_updated
                      ? (threatModel.status_updated | date: 'short' : undefined : currentLocale)
                      : '—'
                  }}</span>
                </div>
              }
            </div>
          </div>

          <form [formGroup]="threatModelForm" class="threat-model-form">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label [transloco]="'common.name'">Name</mat-label>
              <input
                matInput
                formControlName="name"
                tabindex="1"
                (blur)="onFieldBlur('name', $event)"
              />
              @if (threatModelForm.get('name')?.hasError('required')) {
                <mat-error>
                  {{ 'common.validation.required' | transloco }}
                </mat-error>
              }

              @if (threatModelForm.get('name')?.hasError('maxlength')) {
                <mat-error>
                  {{ 'common.validation.maxLength' | transloco: { max: 100 } }}
                </mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label [transloco]="'common.description'">Description</mat-label>
              <textarea
                matInput
                formControlName="description"
                rows="4"
                tabindex="2"
                placeholder="{{ 'threatModels.descriptionPlaceholder' | transloco }}"
                (blur)="onFieldBlur('description', $event)"
              ></textarea>
              @if (threatModelForm.get('description')?.hasError('maxlength')) {
                <mat-error>
                  {{ 'common.validation.maxLength' | transloco: { max: 500 } }}
                </mat-error>
              }
            </mat-form-field>

            <!-- New fields for threat model framework and issue URL -->
            <div class="form-fields-row">
              <mat-form-field appearance="outline">
                <mat-label [transloco]="'threatModels.threatModelFramework'"
                  >Threat Model Framework</mat-label
                >
                <mat-select
                  formControlName="threat_model_framework"
                  tabindex="3"
                  [attr.aria-label]="'threatModels.threatModelFramework' | transloco"
                  (selectionChange)="onFrameworkChange($event)"
                >
                  <mat-option *ngFor="let framework of frameworks" [value]="framework.name">
                    {{ framework.name }}
                  </mat-option>
                </mat-select>
                @if (hasThreats()) {
                  <mat-hint>
                    {{ 'threatModels.frameworkDisabledHint' | transloco }}
                  </mat-hint>
                }

                @if (threatModelForm.get('threat_model_framework')?.hasError('required')) {
                  <mat-error>
                    {{ 'common.validation.required' | transloco }}
                  </mat-error>
                }
              </mat-form-field>

              <!-- Issue URI field with hyperlink icon -->
              <div class="issue-uri-container">
                <mat-form-field appearance="outline" class="issue-uri-field">
                  <mat-label [transloco]="'common.issueUri'">Issue URI</mat-label>
                  <input
                    matInput
                    formControlName="issue_uri"
                    type="url"
                    tabindex="4"
                    placeholder="https://example.com/issue/123"
                  />
                  <mat-hint>{{ 'threatModels.issueUriHint' | transloco }}</mat-hint>
                  @if (threatModelForm.get('issue_uri')?.hasError('url')) {
                    <mat-error>
                      {{ 'common.validation.invalidUrl' | transloco }}
                    </mat-error>
                  }
                </mat-form-field>
                <button
                  mat-icon-button
                  type="button"
                  class="issue-uri-icon-button"
                  [disabled]="!isValidUrl(threatModelForm.get('issue_uri')?.value)"
                  (click)="openUriInNewTab(threatModelForm.get('issue_uri')?.value)"
                  [matTooltip]="
                    isValidUrl(threatModelForm.get('issue_uri')?.value)
                      ? threatModelForm.get('issue_uri')?.value
                      : 'Enter a valid URI to open'
                  "
                  matTooltipPosition="above"
                  tabindex="5"
                  [attr.aria-label]="'common.openInNewTab' | transloco"
                >
                  <mat-icon fontSet="material-symbols-outlined">open_in_new</mat-icon>
                </button>
              </div>
            </div>
          </form>
        </mat-card-content>
      </mat-card>

      <!-- Assets Card -->
      <mat-card class="assets-card">
        <mat-card-header>
          <mat-card-title
            [transloco]="'common.objectTypes.assets'"
            [matTooltip]="'threatModels.tooltips.assetsCardTitle' | transloco"
            >Assets</mat-card-title
          >
          @if (canEdit) {
            <div class="header-actions">
              <button
                mat-icon-button
                color="primary"
                [matMenuTriggerFor]="assetsAddonsMenu"
                [matTooltip]="'common.addons' | transloco"
                [attr.aria-label]="'common.addons' | transloco"
              >
                <mat-icon>extension</mat-icon>
              </button>
              <button
                mat-icon-button
                color="primary"
                (click)="addAsset()"
                [matTooltip]="'threatModels.tooltips.addAsset' | transloco"
                [attr.aria-label]="'threatModels.tooltips.addAsset' | transloco"
              >
                <mat-icon>add</mat-icon>
              </button>
            </div>
          }
        </mat-card-header>
        <mat-card-content>
          <div class="table-container">
            <table
              mat-table
              [dataSource]="assetsDataSource"
              class="entity-table assets-table"
              matSort
              #assetsSort="matSort"
              matSortActive="name"
              matSortDirection="asc"
            >
              <!-- Icon Column -->
              <ng-container matColumnDef="icon">
                <th mat-header-cell *matHeaderCellDef class="column-icon"></th>
                <td mat-cell *matCellDef="let asset" class="column-icon">
                  <mat-icon
                    class="material-symbols-outlined"
                    [matTooltip]="asset.type ? ('assetEditor.types.' + asset.type | transloco) : ''"
                    matTooltipPosition="above"
                  >
                    {{ getAssetTypeIcon(asset.type) }}
                  </mat-icon>
                </td>
              </ng-container>

              <!-- Name Column -->
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="column-name">
                  {{ 'common.name' | transloco }}
                </th>
                <td mat-cell *matCellDef="let asset" class="column-name">
                  {{ asset.name }}
                </td>
              </ng-container>

              <!-- Description Column -->
              <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef class="column-description">
                  {{ 'common.description' | transloco }}
                </th>
                <td mat-cell *matCellDef="let asset" class="column-description">
                  <span class="description-text">{{ asset.description || '-' }}</span>
                </td>
              </ng-container>

              <!-- Criticality Column -->
              <ng-container matColumnDef="criticality">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="column-criticality">
                  {{ 'common.criticality' | transloco }}
                </th>
                <td mat-cell *matCellDef="let asset" class="column-criticality">
                  {{ asset.criticality || '-' }}
                </td>
              </ng-container>

              <!-- Sensitivity Column -->
              <ng-container matColumnDef="sensitivity">
                <th mat-header-cell *matHeaderCellDef class="column-sensitivity">
                  {{ 'common.sensitivity' | transloco }}
                </th>
                <td mat-cell *matCellDef="let asset" class="column-sensitivity">
                  @if (asset.sensitivity) {
                    <span class="sensitivity-badge">{{ asset.sensitivity }}</span>
                  } @else {
                    -
                  }
                </td>
              </ng-container>

              <!-- Classification Column -->
              <ng-container matColumnDef="classification">
                <th mat-header-cell *matHeaderCellDef class="column-classification">
                  {{ 'common.classification' | transloco }}
                </th>
                <td mat-cell *matCellDef="let asset" class="column-classification">
                  @if (asset.classification?.length) {
                    <span class="classification-badges">
                      @for (item of asset.classification; track item) {
                        <span class="classification-badge">{{ item }}</span>
                      }
                    </span>
                  } @else {
                    -
                  }
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="column-actions">
                  {{ 'common.actions' | transloco }}
                </th>
                <td mat-cell *matCellDef="let asset" class="column-actions">
                  <div class="action-buttons">
                    @if (canEdit) {
                      <button
                        mat-icon-button
                        color="primary"
                        [matMenuTriggerFor]="assetRowAddonsMenu"
                        [matTooltip]="'common.addons' | transloco"
                        [attr.aria-label]="'common.addons' | transloco"
                        (click)="
                          $event.stopPropagation();
                          setAddonRowContext('asset', asset.id, asset.name)
                        "
                      >
                        <mat-icon>extension</mat-icon>
                      </button>
                    }
                    <button
                      mat-icon-button
                      (click)="openAssetMetadataDialog(asset, $event)"
                      [matTooltip]="
                        canEdit
                          ? ('common.manageMetadata' | transloco)
                          : ('common.viewMetadata' | transloco)
                      "
                      [attr.aria-label]="
                        canEdit
                          ? ('common.manageMetadata' | transloco)
                          : ('common.viewMetadata' | transloco)
                      "
                    >
                      <mat-icon>list</mat-icon>
                    </button>
                    @if (canEdit) {
                      <button
                        mat-icon-button
                        color="warn"
                        (click)="deleteAsset(asset, $event)"
                        [matTooltip]="'common.delete' | transloco"
                        [attr.aria-label]="'common.delete' | transloco"
                      >
                        <mat-icon>delete</mat-icon>
                      </button>
                    }
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="assetsDisplayedColumns"></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: assetsDisplayedColumns"
                class="clickable-row"
                [matTooltip]="row.description"
                matTooltipClass="entity-description-tooltip"
                matTooltipPosition="above"
                (click)="editAsset(row, $event)"
              ></tr>
            </table>
          </div>
          @if (!assetsDataSource.data.length) {
            <div class="no-items-message">
              {{ 'threatModels.noAssets' | transloco }}
            </div>
          }

          <!-- Assets Paginator -->
          @if (totalAssets > assetsPageSize) {
            <mat-paginator
              #assetsPaginator
              [length]="totalAssets"
              [pageSize]="assetsPageSize"
              [pageIndex]="assetsPageIndex"
              [pageSizeOptions]="subtablePageSizeOptions"
              (page)="onAssetsPageChange($event)"
              [attr.aria-label]="'pagination.ariaLabel' | transloco"
            >
            </mat-paginator>
          }
        </mat-card-content>
      </mat-card>

      <!-- Threats Card -->
      <mat-card class="threats-card">
        <mat-card-header>
          <mat-card-title
            [transloco]="'common.objectTypes.threats'"
            [matTooltip]="'threatModels.tooltips.threatsCardTitle' | transloco"
            >Threats</mat-card-title
          >
          @if (canEdit) {
            <div class="header-actions">
              <button
                mat-icon-button
                color="primary"
                [matMenuTriggerFor]="threatsAddonsMenu"
                [matTooltip]="'common.addons' | transloco"
                [attr.aria-label]="'common.addons' | transloco"
              >
                <mat-icon>extension</mat-icon>
              </button>
              <button
                mat-icon-button
                color="primary"
                (click)="openThreatEditor()"
                [matTooltip]="'common.addThreat' | transloco"
              >
                <mat-icon>add</mat-icon>
              </button>
            </div>
          }
        </mat-card-header>
        <mat-card-content>
          <div class="table-container">
            <table
              mat-table
              [dataSource]="threatsDataSource"
              class="entity-table threats-table"
              matSort
              #threatsSort="matSort"
              matSortActive="severity"
              matSortDirection="asc"
            >
              <!-- Icon Column -->
              <ng-container matColumnDef="icon">
                <th mat-header-cell *matHeaderCellDef class="column-icon"></th>
                <td mat-cell *matCellDef="let threat" class="column-icon">
                  <mat-icon
                    class="material-symbols-outlined"
                    [matTooltip]="
                      threat.threat_type && threat.threat_type.length > 0
                        ? threat.threat_type.join('\n')
                        : ''
                    "
                    matTooltipPosition="above"
                    >skull</mat-icon
                  >
                </td>
              </ng-container>

              <!-- Name Column -->
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="column-name">
                  {{ 'common.name' | transloco }}
                </th>
                <td mat-cell *matCellDef="let threat" class="column-name">
                  {{ threat.name }}
                </td>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="column-status">
                  {{ 'common.status' | transloco }}
                </th>
                <td mat-cell *matCellDef="let threat" class="column-status">
                  @if (threat.status) {
                    <span class="status-badge">
                      {{ 'threatEditor.threatStatus.' + threat.status | transloco }}
                    </span>
                  } @else {
                    -
                  }
                </td>
              </ng-container>

              <!-- Mitigated Column -->
              <ng-container matColumnDef="mitigated">
                <th mat-header-cell *matHeaderCellDef class="column-mitigated">
                  {{ 'common.mitigated' | transloco }}
                </th>
                <td mat-cell *matCellDef="let threat" class="column-mitigated">
                  @if (threat.mitigated) {
                    <mat-icon class="mitigated-check">check</mat-icon>
                  }
                </td>
              </ng-container>

              <!-- Severity Column -->
              <ng-container matColumnDef="severity">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="column-severity">
                  {{ 'common.severity' | transloco }}
                </th>
                <td mat-cell *matCellDef="let threat" class="column-severity">
                  @if (threat.severity) {
                    <span class="severity-badge" [ngClass]="'severity-' + threat.severity">
                      {{ 'threatEditor.threatSeverity.' + threat.severity | transloco }}
                    </span>
                  } @else {
                    <span class="severity-badge severity-unknown">
                      {{ 'common.none' | transloco }}
                    </span>
                  }
                </td>
              </ng-container>

              <!-- Description Column -->
              <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef class="column-description">
                  {{ 'common.description' | transloco }}
                </th>
                <td mat-cell *matCellDef="let threat" class="column-description">
                  <span class="description-text">{{ threat.description || '-' }}</span>
                </td>
              </ng-container>

              <!-- Hyperlink Column -->
              <ng-container matColumnDef="hyperlink">
                <th mat-header-cell *matHeaderCellDef class="column-hyperlink"></th>
                <td mat-cell *matCellDef="let threat" class="column-hyperlink">
                  @if (
                    threat.issue_uri && threat.issue_uri !== 'n/a' && threat.issue_uri.trim() !== ''
                  ) {
                    <a
                      [href]="threat.issue_uri"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="external-link-icon"
                      (click)="$event.stopPropagation()"
                      [matTooltip]="threat.issue_uri"
                      matTooltipPosition="above"
                    >
                      <mat-icon fontSet="material-symbols-outlined">open_in_new</mat-icon>
                    </a>
                  }
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="column-actions">
                  {{ 'common.actions' | transloco }}
                </th>
                <td mat-cell *matCellDef="let threat" class="column-actions">
                  <div class="action-buttons">
                    @if (canEdit) {
                      <button
                        mat-icon-button
                        color="primary"
                        [matMenuTriggerFor]="threatRowAddonsMenu"
                        [matTooltip]="'common.addons' | transloco"
                        [attr.aria-label]="'common.addons' | transloco"
                        (click)="
                          $event.stopPropagation();
                          setAddonRowContext('threat', threat.id, threat.name)
                        "
                      >
                        <mat-icon>extension</mat-icon>
                      </button>
                    }
                    <button
                      mat-icon-button
                      (click)="openThreatMetadataDialog(threat, $event)"
                      [matTooltip]="
                        canEdit
                          ? ('common.manageMetadata' | transloco)
                          : ('common.viewMetadata' | transloco)
                      "
                      [attr.aria-label]="
                        canEdit
                          ? ('common.manageMetadata' | transloco)
                          : ('common.viewMetadata' | transloco)
                      "
                    >
                      <mat-icon>list</mat-icon>
                    </button>
                    @if (canEdit) {
                      <button
                        mat-icon-button
                        color="warn"
                        (click)="deleteThreat(threat, $event)"
                        [matTooltip]="'common.delete' | transloco"
                        [attr.aria-label]="'common.delete' | transloco"
                      >
                        <mat-icon>delete</mat-icon>
                      </button>
                    }
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="threatsDisplayedColumns"></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: threatsDisplayedColumns"
                class="clickable-row"
                [matTooltip]="row.description"
                matTooltipClass="entity-description-tooltip"
                matTooltipPosition="above"
                (click)="openThreatEditor(row)"
              ></tr>
            </table>
          </div>
          @if (!threatsDataSource.data.length) {
            <div class="no-items-message">
              {{ 'threatModels.noThreats' | transloco }}
            </div>
          }

          <!-- Threats Paginator -->
          @if (totalThreats > threatsPageSize) {
            <mat-paginator
              #threatsPaginator
              [length]="totalThreats"
              [pageSize]="threatsPageSize"
              [pageIndex]="threatsPageIndex"
              [pageSizeOptions]="subtablePageSizeOptions"
              (page)="onThreatsPageChange($event)"
              [attr.aria-label]="'pagination.ariaLabel' | transloco"
            >
            </mat-paginator>
          }
        </mat-card-content>
      </mat-card>

      <!-- Diagrams Card -->
      <mat-card class="diagrams-card">
        <mat-card-header>
          <mat-card-title
            [transloco]="'threatModels.diagrams'"
            [matTooltip]="'threatModels.tooltips.diagramsCardTitle' | transloco"
            >Diagrams</mat-card-title
          >
          @if (canEdit) {
            <div class="header-actions">
              <button
                mat-icon-button
                color="primary"
                [matMenuTriggerFor]="diagramsAddonsMenu"
                [matTooltip]="'common.addons' | transloco"
                [attr.aria-label]="'common.addons' | transloco"
              >
                <mat-icon>extension</mat-icon>
              </button>
              <button
                mat-icon-button
                color="primary"
                (click)="addDiagram()"
                [matTooltip]="'threatModels.tooltips.addDiagram' | transloco"
              >
                <mat-icon>add</mat-icon>
              </button>
            </div>
          }
        </mat-card-header>
        <mat-card-content>
          <div class="table-container">
            <table
              mat-table
              [dataSource]="diagramsDataSource"
              class="entity-table diagrams-table"
              matSort
              #diagramsSort="matSort"
              matSortActive="name"
              matSortDirection="asc"
            >
              <!-- Icon Column -->
              <ng-container matColumnDef="icon">
                <th mat-header-cell *matHeaderCellDef class="column-icon"></th>
                <td mat-cell *matCellDef="let diagram" class="column-icon">
                  <mat-icon
                    class="material-symbols-outlined"
                    [matTooltip]="getDiagramTooltip(diagram)"
                    matTooltipPosition="above"
                  >
                    {{ getDiagramIcon(diagram) }}
                  </mat-icon>
                </td>
              </ng-container>

              <!-- Name Column -->
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="column-name">
                  {{ 'common.name' | transloco }}
                </th>
                <td mat-cell *matCellDef="let diagram" class="column-name">
                  {{ diagram.name }}
                </td>
              </ng-container>

              <!-- Description Column -->
              <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef class="column-description">
                  {{ 'common.description' | transloco }}
                </th>
                <td mat-cell *matCellDef="let diagram" class="column-description">
                  <span class="description-text">{{ diagram.description || '-' }}</span>
                </td>
              </ng-container>

              <!-- Thumbnail Column -->
              <ng-container matColumnDef="thumbnail">
                <th mat-header-cell *matHeaderCellDef class="column-thumbnail"></th>
                <td mat-cell *matCellDef="let diagram" class="column-thumbnail">
                  @if (hasSvgImage(diagram)) {
                    <div class="diagram-thumbnail-container">
                      <div
                        class="diagram-thumbnail"
                        [matTooltip]="
                          hoveredDiagramId === diagram.id
                            ? ''
                            : ('threatModels.diagramPreview' | transloco)
                        "
                        matTooltipPosition="above"
                        [matTooltipDisabled]="hoveredDiagramId === diagram.id"
                        [attr.aria-label]="'Thumbnail of ' + diagram.name"
                        (mouseenter)="onThumbnailHover(diagram.id)"
                        (mouseleave)="onThumbnailLeave()"
                      >
                        <svg style="width: 100%; height: 100%" preserveAspectRatio="xMidYMid meet">
                          <image
                            [attr.xlink:href]="getSvgDataUrl(diagram)"
                            width="100%"
                            height="100%"
                          />
                        </svg>
                      </div>
                    </div>
                  }
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="column-actions">
                  {{ 'common.actions' | transloco }}
                </th>
                <td mat-cell *matCellDef="let diagram" class="column-actions">
                  <div class="action-buttons">
                    @if (canEdit) {
                      <button
                        mat-icon-button
                        color="primary"
                        [matMenuTriggerFor]="diagramRowAddonsMenu"
                        [matTooltip]="'common.addons' | transloco"
                        [attr.aria-label]="'common.addons' | transloco"
                        (click)="
                          $event.stopPropagation();
                          setAddonRowContext('diagram', diagram.id, diagram.name)
                        "
                      >
                        <mat-icon>extension</mat-icon>
                      </button>
                    }
                    <button
                      mat-icon-button
                      (click)="openDiagramMetadataDialog(diagram, $event)"
                      [matTooltip]="
                        canEdit
                          ? ('common.manageMetadata' | transloco)
                          : ('common.viewMetadata' | transloco)
                      "
                      [attr.aria-label]="
                        canEdit
                          ? ('common.manageMetadata' | transloco)
                          : ('common.viewMetadata' | transloco)
                      "
                    >
                      <mat-icon>list</mat-icon>
                    </button>
                    <button
                      mat-icon-button
                      [matMenuTriggerFor]="downloadModelMenu"
                      [matTooltip]="'threatModels.tooltips.downloadModel' | transloco"
                      [attr.aria-label]="'threatModels.tooltips.downloadModel' | transloco"
                      (click)="$event.stopPropagation()"
                    >
                      <mat-icon class="download-icon">download</mat-icon>
                    </button>
                    <mat-menu #downloadModelMenu="matMenu">
                      <button mat-menu-item (click)="downloadDiagramModel(diagram, 'json')">
                        JSON
                      </button>
                      <button mat-menu-item (click)="downloadDiagramModel(diagram, 'yaml')">
                        YAML
                      </button>
                      <button mat-menu-item (click)="downloadDiagramModel(diagram, 'graphml')">
                        GraphML
                      </button>
                    </mat-menu>
                    @if (canEdit) {
                      <button
                        mat-icon-button
                        color="warn"
                        (click)="deleteDiagram(diagram, $event)"
                        [matTooltip]="'common.delete' | transloco"
                        [attr.aria-label]="'common.delete' | transloco"
                      >
                        <mat-icon>delete</mat-icon>
                      </button>
                    }
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="diagramsDisplayedColumns"></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: diagramsDisplayedColumns"
                class="clickable-row"
                [matTooltip]="row.description"
                matTooltipClass="entity-description-tooltip"
                matTooltipPosition="above"
                [routerLink]="['/tm', threatModel.id, 'dfd', row.id]"
              ></tr>
            </table>
          </div>
          @if (!diagramsDataSource.data.length) {
            <div class="no-items-message">
              {{ 'threatModels.noDiagrams' | transloco }}
            </div>
          }

          <!-- Diagrams Paginator -->
          @if (totalDiagrams > diagramsPageSize) {
            <mat-paginator
              #diagramsPaginator
              [length]="totalDiagrams"
              [pageSize]="diagramsPageSize"
              [pageIndex]="diagramsPageIndex"
              [pageSizeOptions]="subtablePageSizeOptions"
              (page)="onDiagramsPageChange($event)"
              [attr.aria-label]="'pagination.ariaLabel' | transloco"
            >
            </mat-paginator>
          }
        </mat-card-content>
      </mat-card>

      <!-- Notes Card -->
      <mat-card class="notes-card">
        <mat-card-header>
          <mat-card-title
            [transloco]="'common.objectTypes.notes'"
            [matTooltip]="'threatModels.tooltips.notesCardTitle' | transloco"
            >Notes</mat-card-title
          >
          @if (canEdit) {
            <div class="header-actions">
              <button
                mat-icon-button
                color="primary"
                [matMenuTriggerFor]="notesAddonsMenu"
                [matTooltip]="'common.addons' | transloco"
                [attr.aria-label]="'common.addons' | transloco"
              >
                <mat-icon>extension</mat-icon>
              </button>
              <button
                mat-icon-button
                color="primary"
                (click)="addNote()"
                [matTooltip]="'threatModels.tooltips.addNote' | transloco"
                [attr.aria-label]="'threatModels.tooltips.addNote' | transloco"
              >
                <mat-icon>add</mat-icon>
              </button>
            </div>
          }
        </mat-card-header>
        <mat-card-content>
          <div class="table-container">
            <table
              mat-table
              [dataSource]="notesDataSource"
              class="entity-table notes-table"
              matSort
              #notesSort="matSort"
              matSortActive="name"
              matSortDirection="asc"
            >
              <!-- Icon Column -->
              <ng-container matColumnDef="icon">
                <th mat-header-cell *matHeaderCellDef class="column-icon"></th>
                <td mat-cell *matCellDef="let note" class="column-icon">
                  <mat-icon class="material-symbols-outlined">article</mat-icon>
                </td>
              </ng-container>

              <!-- Name Column -->
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="column-name">
                  {{ 'common.name' | transloco }}
                </th>
                <td mat-cell *matCellDef="let note" class="column-name">
                  {{ note.name }}
                </td>
              </ng-container>

              <!-- Description Column -->
              <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef class="column-description">
                  {{ 'common.description' | transloco }}
                </th>
                <td mat-cell *matCellDef="let note" class="column-description">
                  <span class="description-text">{{ note.description || '-' }}</span>
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="column-actions">
                  {{ 'common.actions' | transloco }}
                </th>
                <td mat-cell *matCellDef="let note" class="column-actions">
                  <div class="action-buttons">
                    <button
                      mat-icon-button
                      (click)="downloadNote(note, $event)"
                      [matTooltip]="'common.download' | transloco"
                      [attr.aria-label]="'common.download' | transloco"
                    >
                      <mat-icon>download</mat-icon>
                    </button>
                    @if (canEdit) {
                      <button
                        mat-icon-button
                        color="primary"
                        [matMenuTriggerFor]="noteRowAddonsMenu"
                        [matTooltip]="'common.addons' | transloco"
                        [attr.aria-label]="'common.addons' | transloco"
                        (click)="
                          $event.stopPropagation(); setAddonRowContext('note', note.id, note.name)
                        "
                      >
                        <mat-icon>extension</mat-icon>
                      </button>
                    }
                    <button
                      mat-icon-button
                      (click)="openNoteMetadataDialog(note, $event)"
                      [matTooltip]="
                        canEdit
                          ? ('common.manageMetadata' | transloco)
                          : ('common.viewMetadata' | transloco)
                      "
                      [attr.aria-label]="
                        canEdit
                          ? ('common.manageMetadata' | transloco)
                          : ('common.viewMetadata' | transloco)
                      "
                    >
                      <mat-icon>list</mat-icon>
                    </button>
                    @if (canEdit) {
                      <button
                        mat-icon-button
                        color="warn"
                        (click)="deleteNote(note, $event)"
                        [matTooltip]="'common.delete' | transloco"
                        [attr.aria-label]="'common.delete' | transloco"
                      >
                        <mat-icon>delete</mat-icon>
                      </button>
                    }
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="notesDisplayedColumns"></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: notesDisplayedColumns"
                class="clickable-row"
                [matTooltip]="row.description"
                matTooltipClass="entity-description-tooltip"
                matTooltipPosition="above"
                (click)="editNote(row, $event)"
              ></tr>
            </table>
          </div>
          @if (!notesDataSource.data.length) {
            <div class="no-items-message">
              {{ 'threatModels.noNotes' | transloco }}
            </div>
          }

          <!-- Notes Paginator -->
          @if (totalNotes > notesPageSize) {
            <mat-paginator
              #notesPaginator
              [length]="totalNotes"
              [pageSize]="notesPageSize"
              [pageIndex]="notesPageIndex"
              [pageSizeOptions]="subtablePageSizeOptions"
              (page)="onNotesPageChange($event)"
              [attr.aria-label]="'pagination.ariaLabel' | transloco"
            >
            </mat-paginator>
          }
        </mat-card-content>
      </mat-card>

      <!-- Documents Card -->
      <mat-card class="documents-card">
        <mat-card-header>
          <mat-card-title
            [transloco]="'common.objectTypes.documents'"
            [matTooltip]="'threatModels.tooltips.documentsCardTitle' | transloco"
            >Documents</mat-card-title
          >
          @if (canEdit) {
            <div class="header-actions">
              <button
                mat-icon-button
                color="primary"
                [matMenuTriggerFor]="documentsAddonsMenu"
                [matTooltip]="'common.addons' | transloco"
                [attr.aria-label]="'common.addons' | transloco"
              >
                <mat-icon>extension</mat-icon>
              </button>
              <button
                mat-icon-button
                color="primary"
                (click)="addDocument()"
                [matTooltip]="'threatModels.tooltips.addDocument' | transloco"
              >
                <mat-icon>add</mat-icon>
              </button>
            </div>
          }
        </mat-card-header>
        <mat-card-content>
          <div class="table-container">
            <table
              mat-table
              [dataSource]="documentsDataSource"
              class="entity-table documents-table"
              matSort
              #documentsSort="matSort"
              matSortActive="name"
              matSortDirection="asc"
            >
              <!-- Icon Column -->
              <ng-container matColumnDef="icon">
                <th mat-header-cell *matHeaderCellDef class="column-icon"></th>
                <td mat-cell *matCellDef="let document" class="column-icon">
                  <mat-icon class="material-symbols-outlined">description</mat-icon>
                </td>
              </ng-container>

              <!-- Name Column -->
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="column-name">
                  {{ 'common.name' | transloco }}
                </th>
                <td mat-cell *matCellDef="let document" class="column-name">
                  {{ document.name }}
                </td>
              </ng-container>

              <!-- Description Column -->
              <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef class="column-description">
                  {{ 'common.description' | transloco }}
                </th>
                <td mat-cell *matCellDef="let document" class="column-description">
                  <span class="description-text">{{ document.description || '-' }}</span>
                </td>
              </ng-container>

              <!-- Hyperlink Column -->
              <ng-container matColumnDef="hyperlink">
                <th mat-header-cell *matHeaderCellDef class="column-hyperlink"></th>
                <td mat-cell *matCellDef="let document" class="column-hyperlink">
                  @if (document.uri && document.uri.trim() !== '') {
                    <a
                      [href]="document.uri"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="external-link-icon"
                      (click)="$event.stopPropagation()"
                      [matTooltip]="document.uri"
                      matTooltipPosition="above"
                    >
                      <mat-icon fontSet="material-symbols-outlined">open_in_new</mat-icon>
                    </a>
                  }
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="column-actions">
                  {{ 'common.actions' | transloco }}
                </th>
                <td mat-cell *matCellDef="let document" class="column-actions">
                  <div class="action-buttons">
                    @if (canEdit) {
                      <button
                        mat-icon-button
                        color="primary"
                        [matMenuTriggerFor]="documentRowAddonsMenu"
                        [matTooltip]="'common.addons' | transloco"
                        [attr.aria-label]="'common.addons' | transloco"
                        (click)="
                          $event.stopPropagation();
                          setAddonRowContext('document', document.id, document.name)
                        "
                      >
                        <mat-icon>extension</mat-icon>
                      </button>
                    }
                    <button
                      mat-icon-button
                      (click)="openDocumentMetadataDialog(document, $event)"
                      [matTooltip]="
                        canEdit
                          ? ('common.manageMetadata' | transloco)
                          : ('common.viewMetadata' | transloco)
                      "
                      [attr.aria-label]="
                        canEdit
                          ? ('common.manageMetadata' | transloco)
                          : ('common.viewMetadata' | transloco)
                      "
                    >
                      <mat-icon>list</mat-icon>
                    </button>
                    @if (canEdit) {
                      <button
                        mat-icon-button
                        color="warn"
                        (click)="deleteDocument(document, $event)"
                        [matTooltip]="'common.delete' | transloco"
                        [attr.aria-label]="'common.delete' | transloco"
                      >
                        <mat-icon>delete</mat-icon>
                      </button>
                    }
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="documentsDisplayedColumns"></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: documentsDisplayedColumns"
                class="clickable-row"
                [matTooltip]="row.description"
                matTooltipClass="entity-description-tooltip"
                matTooltipPosition="above"
                (click)="editDocument(row, $event)"
              ></tr>
            </table>
          </div>
          @if (!documentsDataSource.data.length) {
            <div class="no-items-message">
              {{ 'threatModels.noDocuments' | transloco }}
            </div>
          }
          <!-- Documents Paginator -->
          @if (totalDocuments > documentsPageSize) {
            <mat-paginator
              #documentsPaginator
              [length]="totalDocuments"
              [pageSize]="documentsPageSize"
              [pageIndex]="documentsPageIndex"
              [pageSizeOptions]="subtablePageSizeOptions"
              (page)="onDocumentsPageChange($event)"
              [attr.aria-label]="'pagination.ariaLabel' | transloco"
            >
            </mat-paginator>
          }
        </mat-card-content>
      </mat-card>

      <!-- Repositories Card -->
      <mat-card class="repository-card">
        <mat-card-header>
          <mat-card-title
            [transloco]="'common.objectTypes.repositories'"
            [matTooltip]="'threatModels.tooltips.repositoriesCardTitle' | transloco"
            >Repositories</mat-card-title
          >
          @if (canEdit) {
            <div class="header-actions">
              <button
                mat-icon-button
                color="primary"
                [matMenuTriggerFor]="repositoriesAddonsMenu"
                [matTooltip]="'common.addons' | transloco"
                [attr.aria-label]="'common.addons' | transloco"
              >
                <mat-icon>extension</mat-icon>
              </button>
              <button
                mat-icon-button
                color="primary"
                (click)="addRepository()"
                [matTooltip]="'threatModels.createNewRepository' | transloco"
              >
                <mat-icon>add</mat-icon>
              </button>
            </div>
          }
        </mat-card-header>
        <mat-card-content>
          <div class="table-container">
            <table
              mat-table
              [dataSource]="repositoriesDataSource"
              class="entity-table repositories-table"
              matSort
              #repositoriesSort="matSort"
              matSortActive="name"
              matSortDirection="asc"
            >
              <!-- Icon Column -->
              <ng-container matColumnDef="icon">
                <th mat-header-cell *matHeaderCellDef class="column-icon"></th>
                <td mat-cell *matCellDef="let repository" class="column-icon">
                  <mat-icon class="material-symbols-outlined">code</mat-icon>
                </td>
              </ng-container>

              <!-- Name Column -->
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="column-name">
                  {{ 'common.name' | transloco }}
                </th>
                <td mat-cell *matCellDef="let repository" class="column-name">
                  {{ repository.name }}
                </td>
              </ng-container>

              <!-- Description Column -->
              <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef class="column-description">
                  {{ 'common.description' | transloco }}
                </th>
                <td mat-cell *matCellDef="let repository" class="column-description">
                  <span class="description-text">{{ repository.description || '-' }}</span>
                </td>
              </ng-container>

              <!-- Hyperlink Column -->
              <ng-container matColumnDef="hyperlink">
                <th mat-header-cell *matHeaderCellDef class="column-hyperlink"></th>
                <td mat-cell *matCellDef="let repository" class="column-hyperlink">
                  @if (repository.uri && repository.uri.trim() !== '') {
                    <a
                      [href]="repository.uri"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="external-link-icon"
                      (click)="$event.stopPropagation()"
                      [matTooltip]="repository.uri"
                      matTooltipPosition="above"
                    >
                      <mat-icon fontSet="material-symbols-outlined">open_in_new</mat-icon>
                    </a>
                  }
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="column-actions">
                  {{ 'common.actions' | transloco }}
                </th>
                <td mat-cell *matCellDef="let repository" class="column-actions">
                  <div class="action-buttons">
                    @if (canEdit) {
                      <button
                        mat-icon-button
                        color="primary"
                        [matMenuTriggerFor]="repositoryRowAddonsMenu"
                        [matTooltip]="'common.addons' | transloco"
                        [attr.aria-label]="'common.addons' | transloco"
                        (click)="
                          $event.stopPropagation();
                          setAddonRowContext('repository', repository.id, repository.name)
                        "
                      >
                        <mat-icon>extension</mat-icon>
                      </button>
                    }
                    <button
                      mat-icon-button
                      (click)="openRepositoryMetadataDialog(repository, $event)"
                      [matTooltip]="
                        canEdit
                          ? ('common.manageMetadata' | transloco)
                          : ('common.viewMetadata' | transloco)
                      "
                      [attr.aria-label]="
                        canEdit
                          ? ('common.manageMetadata' | transloco)
                          : ('common.viewMetadata' | transloco)
                      "
                    >
                      <mat-icon>list</mat-icon>
                    </button>
                    @if (canEdit) {
                      <button
                        mat-icon-button
                        color="warn"
                        (click)="deleteRepository(repository, $event)"
                        [matTooltip]="'common.delete' | transloco"
                        [attr.aria-label]="'common.delete' | transloco"
                      >
                        <mat-icon>delete</mat-icon>
                      </button>
                    }
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="repositoriesDisplayedColumns"></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: repositoriesDisplayedColumns"
                class="clickable-row"
                [matTooltip]="row.description"
                matTooltipClass="entity-description-tooltip"
                matTooltipPosition="above"
                (click)="editRepository(row, $event)"
              ></tr>
            </table>
          </div>
          @if (!repositoriesDataSource.data.length) {
            <div class="no-items-message">
              {{ 'threatModels.noRepositories' | transloco }}
            </div>
          }
          <!-- Repositories Paginator -->
          @if (totalRepositories > repositoriesPageSize) {
            <mat-paginator
              #repositoriesPaginator
              [length]="totalRepositories"
              [pageSize]="repositoriesPageSize"
              [pageIndex]="repositoriesPageIndex"
              [pageSizeOptions]="subtablePageSizeOptions"
              (page)="onRepositoriesPageChange($event)"
              [attr.aria-label]="'pagination.ariaLabel' | transloco"
            >
            </mat-paginator>
          }
        </mat-card-content>
      </mat-card>
    </div>
  }

  <!-- Global Hover Preview Overlay (rendered outside all containers) -->
  @if (hoveredDiagramId) {
    <div class="diagram-hover-preview-global" [attr.aria-hidden]="true">
      <svg style="width: 100%; height: 100%" preserveAspectRatio="xMidYMid meet">
        <image [attr.xlink:href]="getHoveredDiagramSvgUrl()" width="100%" height="100%" />
      </svg>
    </div>
  }

  <!-- Addon Menus -->

  <!-- Threat Model Details Addons Menu -->
  <mat-menu #detailsAddonsMenu="matMenu">
    @if (addonsForThreatModel.length === 0) {
      <button mat-menu-item disabled>
        <mat-icon>info</mat-icon>
        <span [transloco]="'common.noAddonsAvailable'">No addons available</span>
      </button>
    } @else {
      @for (addon of addonsForThreatModel; track addon.id) {
        <button
          mat-menu-item
          [matTooltip]="addon.description || ''"
          matTooltipPosition="right"
          (click)="invokeAddonForThreatModel(addon)"
        >
          <mat-icon>{{ getAddonIcon(addon) }}</mat-icon>
          <span>{{ addon.name }}</span>
        </button>
      }
    }
  </mat-menu>

  <!-- Assets Card Addons Menu -->
  <mat-menu #assetsAddonsMenu="matMenu">
    @if (addonsForAsset.length === 0) {
      <button mat-menu-item disabled>
        <mat-icon>info</mat-icon>
        <span [transloco]="'common.noAddonsAvailable'">No addons available</span>
      </button>
    } @else {
      @for (addon of addonsForAsset; track addon.id) {
        <button
          mat-menu-item
          [matTooltip]="addon.description || ''"
          matTooltipPosition="right"
          (click)="invokeAddonForAssets(addon)"
        >
          <mat-icon>{{ getAddonIcon(addon) }}</mat-icon>
          <span>{{ addon.name }}</span>
        </button>
      }
    }
  </mat-menu>

  <!-- Asset Row Addons Menu -->
  <mat-menu #assetRowAddonsMenu="matMenu" (closed)="clearAddonRowContext()">
    @if (addonsForAsset.length === 0) {
      <button mat-menu-item disabled>
        <mat-icon>info</mat-icon>
        <span [transloco]="'common.noAddonsAvailable'">No addons available</span>
      </button>
    } @else {
      @for (addon of addonsForAsset; track addon.id) {
        <button
          mat-menu-item
          [matTooltip]="addon.description || ''"
          matTooltipPosition="right"
          (click)="invokeAddonWithRowContext(addon)"
        >
          <mat-icon>{{ getAddonIcon(addon) }}</mat-icon>
          <span>{{ addon.name }}</span>
        </button>
      }
    }
  </mat-menu>

  <!-- Threats Card Addons Menu -->
  <mat-menu #threatsAddonsMenu="matMenu">
    @if (addonsForThreat.length === 0) {
      <button mat-menu-item disabled>
        <mat-icon>info</mat-icon>
        <span [transloco]="'common.noAddonsAvailable'">No addons available</span>
      </button>
    } @else {
      @for (addon of addonsForThreat; track addon.id) {
        <button
          mat-menu-item
          [matTooltip]="addon.description || ''"
          matTooltipPosition="right"
          (click)="invokeAddonForThreats(addon)"
        >
          <mat-icon>{{ getAddonIcon(addon) }}</mat-icon>
          <span>{{ addon.name }}</span>
        </button>
      }
    }
  </mat-menu>

  <!-- Threat Row Addons Menu -->
  <mat-menu #threatRowAddonsMenu="matMenu" (closed)="clearAddonRowContext()">
    @if (addonsForThreat.length === 0) {
      <button mat-menu-item disabled>
        <mat-icon>info</mat-icon>
        <span [transloco]="'common.noAddonsAvailable'">No addons available</span>
      </button>
    } @else {
      @for (addon of addonsForThreat; track addon.id) {
        <button
          mat-menu-item
          [matTooltip]="addon.description || ''"
          matTooltipPosition="right"
          (click)="invokeAddonWithRowContext(addon)"
        >
          <mat-icon>{{ getAddonIcon(addon) }}</mat-icon>
          <span>{{ addon.name }}</span>
        </button>
      }
    }
  </mat-menu>

  <!-- Diagrams Card Addons Menu -->
  <mat-menu #diagramsAddonsMenu="matMenu">
    @if (addonsForDiagram.length === 0) {
      <button mat-menu-item disabled>
        <mat-icon>info</mat-icon>
        <span [transloco]="'common.noAddonsAvailable'">No addons available</span>
      </button>
    } @else {
      @for (addon of addonsForDiagram; track addon.id) {
        <button
          mat-menu-item
          [matTooltip]="addon.description || ''"
          matTooltipPosition="right"
          (click)="invokeAddonForDiagrams(addon)"
        >
          <mat-icon>{{ getAddonIcon(addon) }}</mat-icon>
          <span>{{ addon.name }}</span>
        </button>
      }
    }
  </mat-menu>

  <!-- Diagram Row Addons Menu -->
  <mat-menu #diagramRowAddonsMenu="matMenu" (closed)="clearAddonRowContext()">
    @if (addonsForDiagram.length === 0) {
      <button mat-menu-item disabled>
        <mat-icon>info</mat-icon>
        <span [transloco]="'common.noAddonsAvailable'">No addons available</span>
      </button>
    } @else {
      @for (addon of addonsForDiagram; track addon.id) {
        <button
          mat-menu-item
          [matTooltip]="addon.description || ''"
          matTooltipPosition="right"
          (click)="invokeAddonWithRowContext(addon)"
        >
          <mat-icon>{{ getAddonIcon(addon) }}</mat-icon>
          <span>{{ addon.name }}</span>
        </button>
      }
    }
  </mat-menu>

  <!-- Notes Card Addons Menu -->
  <mat-menu #notesAddonsMenu="matMenu">
    @if (addonsForNote.length === 0) {
      <button mat-menu-item disabled>
        <mat-icon>info</mat-icon>
        <span [transloco]="'common.noAddonsAvailable'">No addons available</span>
      </button>
    } @else {
      @for (addon of addonsForNote; track addon.id) {
        <button
          mat-menu-item
          [matTooltip]="addon.description || ''"
          matTooltipPosition="right"
          (click)="invokeAddonForNotes(addon)"
        >
          <mat-icon>{{ getAddonIcon(addon) }}</mat-icon>
          <span>{{ addon.name }}</span>
        </button>
      }
    }
  </mat-menu>

  <!-- Note Row Addons Menu -->
  <mat-menu #noteRowAddonsMenu="matMenu" (closed)="clearAddonRowContext()">
    @if (addonsForNote.length === 0) {
      <button mat-menu-item disabled>
        <mat-icon>info</mat-icon>
        <span [transloco]="'common.noAddonsAvailable'">No addons available</span>
      </button>
    } @else {
      @for (addon of addonsForNote; track addon.id) {
        <button
          mat-menu-item
          [matTooltip]="addon.description || ''"
          matTooltipPosition="right"
          (click)="invokeAddonWithRowContext(addon)"
        >
          <mat-icon>{{ getAddonIcon(addon) }}</mat-icon>
          <span>{{ addon.name }}</span>
        </button>
      }
    }
  </mat-menu>

  <!-- Documents Card Addons Menu -->
  <mat-menu #documentsAddonsMenu="matMenu">
    @if (addonsForDocument.length === 0) {
      <button mat-menu-item disabled>
        <mat-icon>info</mat-icon>
        <span [transloco]="'common.noAddonsAvailable'">No addons available</span>
      </button>
    } @else {
      @for (addon of addonsForDocument; track addon.id) {
        <button
          mat-menu-item
          [matTooltip]="addon.description || ''"
          matTooltipPosition="right"
          (click)="invokeAddonForDocuments(addon)"
        >
          <mat-icon>{{ getAddonIcon(addon) }}</mat-icon>
          <span>{{ addon.name }}</span>
        </button>
      }
    }
  </mat-menu>

  <!-- Document Row Addons Menu -->
  <mat-menu #documentRowAddonsMenu="matMenu" (closed)="clearAddonRowContext()">
    @if (addonsForDocument.length === 0) {
      <button mat-menu-item disabled>
        <mat-icon>info</mat-icon>
        <span [transloco]="'common.noAddonsAvailable'">No addons available</span>
      </button>
    } @else {
      @for (addon of addonsForDocument; track addon.id) {
        <button
          mat-menu-item
          [matTooltip]="addon.description || ''"
          matTooltipPosition="right"
          (click)="invokeAddonWithRowContext(addon)"
        >
          <mat-icon>{{ getAddonIcon(addon) }}</mat-icon>
          <span>{{ addon.name }}</span>
        </button>
      }
    }
  </mat-menu>

  <!-- Repositories Card Addons Menu -->
  <mat-menu #repositoriesAddonsMenu="matMenu">
    @if (addonsForRepository.length === 0) {
      <button mat-menu-item disabled>
        <mat-icon>info</mat-icon>
        <span [transloco]="'common.noAddonsAvailable'">No addons available</span>
      </button>
    } @else {
      @for (addon of addonsForRepository; track addon.id) {
        <button
          mat-menu-item
          [matTooltip]="addon.description || ''"
          matTooltipPosition="right"
          (click)="invokeAddonForRepositories(addon)"
        >
          <mat-icon>{{ getAddonIcon(addon) }}</mat-icon>
          <span>{{ addon.name }}</span>
        </button>
      }
    }
  </mat-menu>

  <!-- Repository Row Addons Menu -->
  <mat-menu #repositoryRowAddonsMenu="matMenu" (closed)="clearAddonRowContext()">
    @if (addonsForRepository.length === 0) {
      <button mat-menu-item disabled>
        <mat-icon>info</mat-icon>
        <span [transloco]="'common.noAddonsAvailable'">No addons available</span>
      </button>
    } @else {
      @for (addon of addonsForRepository; track addon.id) {
        <button
          mat-menu-item
          [matTooltip]="addon.description || ''"
          matTooltipPosition="right"
          (click)="invokeAddonWithRowContext(addon)"
        >
          <mat-icon>{{ getAddonIcon(addon) }}</mat-icon>
          <span>{{ addon.name }}</span>
        </button>
      }
    }
  </mat-menu>
</div>

<div class="triage-detail-container">
  @if (isLoading) {
    <div class="loading-container">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Loading response...</p>
    </div>
  } @else if (error) {
    <div class="error-container">
      <mat-icon>error_outline</mat-icon>
      <h2>Error</h2>
      <p>{{ error }}</p>
      <button mat-raised-button color="primary" (click)="goBack()">Back to Triage</button>
    </div>
  } @else if (response) {
    <!-- Header -->
    <div class="detail-header">
      <button mat-icon-button (click)="goBack()" matTooltip="Back to triage">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-title">
        <h1>{{ surveyJson?.title || 'Survey Response' }}</h1>
        <span class="submission-meta">
          Submitted by {{ response.owner.display_name || response.owner.email }}
        </span>
      </div>
      <div class="header-actions">
        @if (response.status === 'submitted') {
          <button mat-stroked-button (click)="approveResponse()" [disabled]="isUpdatingStatus">
            <mat-icon>check_circle</mat-icon>
            Approve
          </button>
          <button mat-stroked-button (click)="returnForRevision('')" [disabled]="isUpdatingStatus">
            <mat-icon>rate_review</mat-icon>
            Return for Revision
          </button>
        }
        @if (response.status === 'ready_for_review') {
          <button
            mat-raised-button
            color="primary"
            (click)="createThreatModel()"
            [disabled]="isUpdatingStatus"
          >
            <mat-icon>security</mat-icon>
            Create Threat Model
          </button>
        }
      </div>
    </div>

    <div class="detail-content">
      <!-- Main content -->
      <div class="content-main">
        <!-- Status Timeline -->
        <mat-card class="timeline-card">
          <mat-card-content>
            <div class="status-timeline">
              @for (entry of statusTimeline; track entry.status) {
                <div
                  class="timeline-entry"
                  [class.active]="entry.isActive"
                  [class.completed]="entry.isCompleted"
                >
                  <div class="timeline-dot">
                    @if (entry.isCompleted) {
                      <mat-icon>check_circle</mat-icon>
                    } @else if (entry.isActive) {
                      <mat-icon>radio_button_checked</mat-icon>
                    } @else {
                      <mat-icon>radio_button_unchecked</mat-icon>
                    }
                  </div>
                  <div class="timeline-label">
                    <span class="timeline-status">{{ entry.label }}</span>
                    @if (entry.timestamp) {
                      <span class="timeline-timestamp">{{ entry.timestamp | date: 'short' }}</span>
                    }
                  </div>
                </div>
                @if (!$last) {
                  <div class="timeline-connector" [class.completed]="entry.isCompleted"></div>
                }
              }
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Survey Responses -->
        <mat-card class="responses-card">
          <mat-card-header>
            <mat-card-title>Survey Responses</mat-card-title>
            <mat-card-subtitle
              >{{ surveyJson?.title || 'Survey' }} v{{
                response.template_version
              }}</mat-card-subtitle
            >
          </mat-card-header>
          <mat-card-content>
            @if (formattedResponses.length === 0) {
              <div class="empty-responses">
                <mat-icon>quiz</mat-icon>
                <p>No responses recorded</p>
              </div>
            } @else {
              <div class="responses-list">
                @for (item of formattedResponses; track item.name) {
                  <div class="response-item">
                    <div class="response-question">{{ item.question }}</div>
                    <div class="response-answer">{{ item.answer }}</div>
                  </div>
                }
              </div>
            }
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Sidebar -->
      <div class="content-sidebar">
        <!-- Submission Info -->
        <mat-card class="info-card">
          <mat-card-header>
            <mat-card-title>Response Details</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Status</span>
                <mat-chip [ngClass]="getStatusClass(response.status)">
                  {{ getStatusLabel(response.status) }}
                </mat-chip>
              </div>

              <div class="info-item">
                <span class="info-label">Submitter</span>
                <span class="info-value">
                  {{ response.owner.display_name || response.owner.email }}
                </span>
              </div>

              @if (response.owner.display_name) {
                <div class="info-item">
                  <span class="info-label">Email</span>
                  <span class="info-value">{{ response.owner.email }}</span>
                </div>
              }

              <div class="info-item">
                <span class="info-label">Version</span>
                <span class="info-value">v{{ response.template_version }}</span>
              </div>

              <div class="info-item">
                <span class="info-label">Created</span>
                <span class="info-value">{{ response.created_at | date: 'medium' }}</span>
              </div>

              @if (response.submitted_at) {
                <div class="info-item">
                  <span class="info-label">Submitted</span>
                  <span class="info-value">{{ response.submitted_at | date: 'medium' }}</span>
                </div>
              }

              <div class="info-item">
                <span class="info-label">Last Modified</span>
                <span class="info-value">{{ response.modified_at | date: 'medium' }}</span>
              </div>

              @if (response.created_threat_model_id) {
                <div class="info-item">
                  <span class="info-label">Threat Model</span>
                  <a [routerLink]="['/tm', response.created_threat_model_id]" class="tm-link">
                    View Threat Model
                  </a>
                </div>
              }

              <div class="info-item">
                <span class="info-label">Response ID</span>
                <span class="info-value monospace">{{ response.id }}</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>
  }
</div>

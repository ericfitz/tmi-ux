<div class="triage-list-container">
  <!-- Header -->
  <div class="page-header">
    <h1 class="page-title">{{ 'triage.queue' | transloco }}</h1>
    @if (selection.selected.length > 0) {
      <div class="bulk-actions">
        <span class="selection-count">{{
          'common.selected' | transloco: { count: selection.selected.length }
        }}</span>
        <button mat-stroked-button (click)="bulkApprove()">
          <mat-icon>check_circle</mat-icon>
          {{ 'triage.list.approveSelected' | transloco }}
        </button>
      </div>
    }
    <button
      mat-icon-button
      class="close-button"
      (click)="onClose()"
      [attr.aria-label]="'common.close' | transloco"
      [matTooltip]="'common.close' | transloco"
    >
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Filters -->
  <div class="filters-row">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>{{ 'common.search' | transloco }}</mat-label>
      <mat-icon matPrefix>search</mat-icon>
      <input
        matInput
        [(ngModel)]="filters.searchTerm"
        (ngModelChange)="onFilterChange()"
        [placeholder]="'triage.list.searchPlaceholder' | transloco"
      />
      @if (filters.searchTerm) {
        <button matSuffix mat-icon-button (click)="filters.searchTerm = ''; onFilterChange()">
          <mat-icon>close</mat-icon>
        </button>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="status-filter">
      <mat-label>{{ 'common.status' | transloco }}</mat-label>
      <mat-select [(ngModel)]="filters.status" (selectionChange)="onFilterChange()">
        @for (option of statusOptions; track option.value) {
          <mat-option [value]="option.value">{{ option.labelKey | transloco }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="template-filter">
      <mat-label>{{ 'common.template' | transloco }}</mat-label>
      <mat-select [(ngModel)]="filters.surveyId" (selectionChange)="onFilterChange()">
        <mat-option [value]="null">{{ 'triage.list.allSurveys' | transloco }}</mat-option>
        @for (survey of surveys; track survey.id) {
          <mat-option [value]="survey.id">{{ survey.name }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    @if (showConfidential) {
      <mat-form-field appearance="outline" class="confidential-filter">
        <mat-label>{{ 'triage.filters.confidential' | transloco }}</mat-label>
        <mat-select [(ngModel)]="filters.isConfidential" (selectionChange)="onFilterChange()">
          <mat-option [value]="null">{{ 'common.all' | transloco }}</mat-option>
          <mat-option [value]="true">{{
            'triage.filters.confidentialOnly' | transloco
          }}</mat-option>
          <mat-option [value]="false">{{
            'triage.filters.nonConfidential' | transloco
          }}</mat-option>
        </mat-select>
      </mat-form-field>
    }

    @if (hasActiveFilters) {
      <button mat-stroked-button (click)="clearFilters()">
        <mat-icon>filter_list_off</mat-icon>
        {{ 'triage.filters.clearFilters' | transloco }}
      </button>
    }
  </div>

  @if (isLoading && dataSource.data.length === 0) {
    <div class="loading-container">
      <mat-spinner diameter="48"></mat-spinner>
      <p>{{ 'triage.list.loadingResponses' | transloco }}</p>
    </div>
  } @else if (error) {
    <div class="error-container">
      <mat-icon>error_outline</mat-icon>
      <h2>{{ 'common.error' | transloco }}</h2>
      <p>{{ error }}</p>
      <button mat-raised-button color="primary" (click)="loadResponses()">
        {{ 'common.retry' | transloco }}
      </button>
    </div>
  } @else if (dataSource.data.length === 0) {
    <div class="empty-state">
      <mat-icon>inbox</mat-icon>
      <h2>{{ 'triage.list.noResponsesTitle' | transloco }}</h2>
      @if (hasActiveFilters) {
        <p>{{ 'triage.list.noResponsesFiltered' | transloco }}</p>
        <button mat-raised-button color="primary" (click)="clearFilters()">
          {{ 'triage.filters.clearFilters' | transloco }}
        </button>
      } @else {
        <p>{{ 'triage.list.noResponsesToTriage' | transloco }}</p>
      }
    </div>
  } @else {
    <div class="responses-table-container">
      <table mat-table [dataSource]="dataSource" class="responses-table">
        <!-- Checkbox Column -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox
              (change)="toggleAllRows()"
              [checked]="isAllSelected()"
              [indeterminate]="selection.hasValue() && !isAllSelected()"
            >
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let row">
            <mat-checkbox
              (click)="$event.stopPropagation()"
              (change)="selection.toggle(row)"
              [checked]="selection.isSelected(row)"
            >
            </mat-checkbox>
          </td>
        </ng-container>

        <!-- Confidential Column -->
        <ng-container matColumnDef="confidential">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let row">
            @if (row.is_confidential) {
              <mat-icon
                class="confidential-icon"
                [matTooltip]="'triage.columns.confidentialTooltip' | transloco"
                >lock</mat-icon
              >
            }
          </td>
        </ng-container>

        <!-- Submitter Column -->
        <ng-container matColumnDef="submitter">
          <th mat-header-cell *matHeaderCellDef>{{ 'triage.list.submitter' | transloco }}</th>
          <td mat-cell *matCellDef="let row">
            <div class="submitter-info">
              <span class="submitter-name"><app-user-display [user]="row.owner" /></span>
              @if (row.owner.display_name) {
                <span class="submitter-email">{{ row.owner.email }}</span>
              }
            </div>
          </td>
        </ng-container>

        <!-- Template Column -->
        <ng-container matColumnDef="template">
          <th mat-header-cell *matHeaderCellDef>{{ 'common.template' | transloco }}</th>
          <td mat-cell *matCellDef="let row">
            <div class="template-info">
              <span class="template-name">{{ row.survey_name ?? '' }}</span>
              @if (row.survey_version) {
                <span class="template-version">v{{ row.survey_version }}</span>
              }
            </div>
          </td>
        </ng-container>

        <!-- Submitted Date Column -->
        <ng-container matColumnDef="submitted_at">
          <th mat-header-cell *matHeaderCellDef>{{ 'triage.list.submitted' | transloco }}</th>
          <td mat-cell *matCellDef="let row">
            @if (row.submitted_at) {
              {{ row.submitted_at | date: 'medium' }}
            } @else {
              <span class="not-submitted">{{ 'triage.list.notSubmitted' | transloco }}</span>
            }
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>{{ 'common.status' | transloco }}</th>
          <td mat-cell *matCellDef="let row">
            <mat-chip [ngClass]="getStatusClass(row.status)">
              {{ 'surveys.status.' + getStatusKey(row.status) | transloco }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let row">
            <button
              mat-icon-button
              [matMenuTriggerFor]="actionMenu"
              (click)="$event.stopPropagation()"
            >
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #actionMenu="matMenu">
              <button mat-menu-item (click)="viewResponse(row)">
                <mat-icon>visibility</mat-icon>
                <span>{{ 'triage.viewDetails' | transloco }}</span>
              </button>
              @if (row.status === 'submitted') {
                <button mat-menu-item (click)="approveResponse(row, $event)">
                  <mat-icon>check_circle</mat-icon>
                  <span>{{ 'triage.list.approve' | transloco }}</span>
                </button>
              }
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns"
          class="response-row"
          (click)="viewResponse(row)"
        ></tr>
      </table>

      <mat-paginator
        [length]="totalResponses"
        [pageSize]="pageSize"
        [pageIndex]="pageIndex"
        [pageSizeOptions]="[10, 25, 50, 100]"
        (page)="onPageChange($event)"
        showFirstLastButtons
      >
      </mat-paginator>
    </div>

    @if (isLoading) {
      <div class="loading-overlay">
        <mat-spinner diameter="32"></mat-spinner>
      </div>
    }
  }
</div>

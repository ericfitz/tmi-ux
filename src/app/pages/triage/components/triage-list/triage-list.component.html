<div class="triage-list-container">
  <!-- Header -->
  <div class="page-header">
    <h1 class="page-title">Triage Queue</h1>
    @if (selection.selected.length > 0) {
      <div class="bulk-actions">
        <span class="selection-count">{{ selection.selected.length }} selected</span>
        <button mat-stroked-button [matMenuTriggerFor]="bulkStatusMenu">
          <mat-icon>edit</mat-icon>
          Change Status
        </button>
        <mat-menu #bulkStatusMenu="matMenu">
          <button mat-menu-item (click)="bulkUpdateStatus('in_review')">
            <mat-icon>visibility</mat-icon>
            Mark In Review
          </button>
          <button mat-menu-item (click)="bulkUpdateStatus('pending_triage')">
            <mat-icon>pending_actions</mat-icon>
            Mark Pending Triage
          </button>
        </mat-menu>
      </div>
    }
  </div>

  <!-- Filters -->
  <div class="filters-row">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Search</mat-label>
      <mat-icon matPrefix>search</mat-icon>
      <input
        matInput
        [(ngModel)]="filters.searchTerm"
        (ngModelChange)="onFilterChange()"
        placeholder="Search by submitter or template..."
      />
      @if (filters.searchTerm) {
        <button matSuffix mat-icon-button (click)="filters.searchTerm = ''; onFilterChange()">
          <mat-icon>close</mat-icon>
        </button>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="status-filter">
      <mat-label>Status</mat-label>
      <mat-select [(ngModel)]="filters.status" (selectionChange)="onFilterChange()">
        @for (option of statusOptions; track option.value) {
          <mat-option [value]="option.value">{{ option.label }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="template-filter">
      <mat-label>Template</mat-label>
      <mat-select [(ngModel)]="filters.templateId" (selectionChange)="onFilterChange()">
        <mat-option [value]="null">All Templates</mat-option>
        @for (template of templates; track template.id) {
          <mat-option [value]="template.id">{{ template.name }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    @if (hasActiveFilters) {
      <button mat-stroked-button (click)="clearFilters()">
        <mat-icon>filter_list_off</mat-icon>
        Clear Filters
      </button>
    }
  </div>

  @if (isLoading && dataSource.data.length === 0) {
    <div class="loading-container">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Loading submissions...</p>
    </div>
  } @else if (error) {
    <div class="error-container">
      <mat-icon>error_outline</mat-icon>
      <h2>Error</h2>
      <p>{{ error }}</p>
      <button mat-raised-button color="primary" (click)="loadSubmissions()">Retry</button>
    </div>
  } @else if (dataSource.data.length === 0) {
    <div class="empty-state">
      <mat-icon>inbox</mat-icon>
      <h2>No Submissions</h2>
      @if (hasActiveFilters) {
        <p>No submissions match your filters</p>
        <button mat-raised-button color="primary" (click)="clearFilters()">Clear Filters</button>
      } @else {
        <p>There are no survey submissions to triage</p>
      }
    </div>
  } @else {
    <div class="submissions-table-container">
      <table mat-table [dataSource]="dataSource" class="submissions-table">
        <!-- Checkbox Column -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox
              (change)="toggleAllRows()"
              [checked]="isAllSelected()"
              [indeterminate]="selection.hasValue() && !isAllSelected()"
            >
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let row">
            <mat-checkbox
              (click)="$event.stopPropagation()"
              (change)="selection.toggle(row)"
              [checked]="selection.isSelected(row)"
            >
            </mat-checkbox>
          </td>
        </ng-container>

        <!-- Submitter Column -->
        <ng-container matColumnDef="submitter">
          <th mat-header-cell *matHeaderCellDef>Submitter</th>
          <td mat-cell *matCellDef="let submission">
            <div class="submitter-info">
              <span class="submitter-name">{{
                submission.user_display_name || submission.user_email
              }}</span>
              @if (submission.user_display_name) {
                <span class="submitter-email">{{ submission.user_email }}</span>
              }
            </div>
          </td>
        </ng-container>

        <!-- Template Column -->
        <ng-container matColumnDef="template">
          <th mat-header-cell *matHeaderCellDef>Template</th>
          <td mat-cell *matCellDef="let submission">
            <div class="template-info">
              <span class="template-name">{{ submission.template_name }}</span>
              <span class="template-version">v{{ submission.template_version }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Submitted Date Column -->
        <ng-container matColumnDef="submitted_at">
          <th mat-header-cell *matHeaderCellDef>Submitted</th>
          <td mat-cell *matCellDef="let submission">
            @if (submission.submitted_at) {
              {{ submission.submitted_at | date: 'medium' }}
            } @else {
              <span class="not-submitted">Not submitted</span>
            }
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let submission">
            <mat-chip [ngClass]="getStatusClass(submission.status)">
              {{ getStatusLabel(submission.status) }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let submission">
            <button
              mat-icon-button
              [matMenuTriggerFor]="actionMenu"
              (click)="$event.stopPropagation()"
            >
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #actionMenu="matMenu">
              <button mat-menu-item (click)="viewSubmission(submission)">
                <mat-icon>visibility</mat-icon>
                <span>View Details</span>
              </button>
              @if (submission.status === 'submitted') {
                <button mat-menu-item (click)="updateStatus(submission, 'in_review', $event)">
                  <mat-icon>rate_review</mat-icon>
                  <span>Mark In Review</span>
                </button>
              }
              @if (submission.status === 'in_review') {
                <button mat-menu-item (click)="updateStatus(submission, 'pending_triage', $event)">
                  <mat-icon>pending_actions</mat-icon>
                  <span>Mark Pending Triage</span>
                </button>
              }
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns"
          class="submission-row"
          (click)="viewSubmission(row)"
        ></tr>
      </table>

      <mat-paginator
        [length]="totalSubmissions"
        [pageSize]="pageSize"
        [pageIndex]="pageIndex"
        [pageSizeOptions]="[10, 25, 50, 100]"
        (page)="onPageChange($event)"
        showFirstLastButtons
      >
      </mat-paginator>
    </div>

    @if (isLoading) {
      <div class="loading-overlay">
        <mat-spinner diameter="32"></mat-spinner>
      </div>
    }
  }
</div>

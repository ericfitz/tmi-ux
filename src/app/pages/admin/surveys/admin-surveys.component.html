<div class="admin-surveys-container">
  <div class="page-header">
    <h1 class="page-title">{{ 'adminSurveys.pageTitle' | transloco }}</h1>
    <div class="action-buttons">
      <button mat-icon-button (click)="onClose()" [attr.aria-label]="'common.close' | transloco">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <div class="filters-row">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>{{ 'adminSurveys.searchTemplates' | transloco }}</mat-label>
      <mat-icon matPrefix>search</mat-icon>
      <input
        matInput
        [(ngModel)]="searchText"
        (input)="onFilterChange()"
        [placeholder]="'adminSurveys.searchByName' | transloco"
      />
      @if (searchText) {
        <button
          matSuffix
          mat-icon-button
          (click)="clearSearch()"
          [matTooltip]="'dashboard.clearSearch' | transloco"
        >
          <mat-icon>close</mat-icon>
        </button>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="status-filter">
      <mat-label>{{ 'common.status' | transloco }}</mat-label>
      <mat-select multiple [(value)]="statusFilter" (selectionChange)="onFilterChange()">
        @for (option of statusOptions; track option.value) {
          <mat-option [value]="option.value">{{ option.labelKey | transloco }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <button mat-flat-button color="primary" class="create-button" (click)="createTemplate()">
      <mat-icon>add</mat-icon>
      {{ 'adminSurveys.createSurvey' | transloco }}
    </button>
  </div>

  @if (loading) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>{{ 'adminSurveys.loadingTemplates' | transloco }}</p>
    </div>
  } @else if (error) {
    <div class="error-container">
      <mat-icon color="warn">error</mat-icon>
      <p>{{ error }}</p>
      <button mat-stroked-button (click)="loadTemplates()">
        <mat-icon>refresh</mat-icon>
        {{ 'common.retry' | transloco }}
      </button>
    </div>
  } @else if (dataSource.data.length === 0) {
    <div class="empty-state">
      <mat-icon>assignment</mat-icon>
      @if (templates.length === 0) {
        <h2>{{ 'adminSurveys.noTemplatesTitle' | transloco }}</h2>
        <p>{{ 'adminSurveys.noTemplatesMessage' | transloco }}</p>
        <button mat-flat-button color="primary" (click)="createTemplate()">
          <mat-icon>add</mat-icon>
          {{ 'adminSurveys.createSurvey' | transloco }}
        </button>
      } @else {
        <h2>{{ 'adminSurveys.noMatchingTitle' | transloco }}</h2>
        <p>{{ 'common.tryAdjustingFilters' | transloco }}</p>
      }
    </div>
  } @else {
    <div class="templates-table-container">
      <table
        mat-table
        [dataSource]="dataSource"
        matSort
        matSortActive="modified"
        matSortDirection="desc"
        class="templates-table"
      >
        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'common.name' | transloco }}</th>
          <td mat-cell *matCellDef="let template">
            @if (isEditing(template.id, 'name')) {
              <input
                class="inline-edit-input"
                [value]="template.name"
                (keydown)="onInlineEditKeydown($event, template, 'name')"
                (blur)="saveInlineEdit(template, 'name', $any($event.target).value)"
                (click)="$event.stopPropagation()"
                #nameInput
              />
            } @else {
              <div class="template-info" (click)="startInlineEdit(template, 'name', $event)">
                <span class="template-name editable">{{ template.name }}</span>
                @if (template.description) {
                  <span class="template-description">{{ template.description }}</span>
                }
              </div>
            }
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ 'common.status' | transloco }}
          </th>
          <td mat-cell *matCellDef="let template">
            <mat-chip [highlighted]="template.status === 'active'">
              <mat-icon matChipIcon>{{ getStatusIcon(template.status) }}</mat-icon>
              {{ 'surveys.templateStatus.' + template.status | transloco }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Version Column -->
        <ng-container matColumnDef="version">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ 'common.version' | transloco }}
          </th>
          <td mat-cell *matCellDef="let template">
            @if (isEditing(template.id, 'version')) {
              <input
                class="inline-edit-input inline-edit-version"
                [value]="template.version"
                (keydown)="onInlineEditKeydown($event, template, 'version')"
                (blur)="saveInlineEdit(template, 'version', $any($event.target).value)"
                (click)="$event.stopPropagation()"
                #versionInput
              />
            } @else {
              <span class="editable" (click)="startInlineEdit(template, 'version', $event)"
                >v{{ template.version }}</span
              >
            }
          </td>
        </ng-container>

        <!-- Modified Column -->
        <ng-container matColumnDef="modified">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ 'common.lastModified' | transloco }}
          </th>
          <td mat-cell *matCellDef="let template">
            {{ template.modified_at ?? template.created_at | date: 'mediumDate' }}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>{{ 'common.actions' | transloco }}</th>
          <td mat-cell *matCellDef="let template">
            <button
              mat-icon-button
              (click)="$event.stopPropagation(); editTemplate(template)"
              [matTooltip]="'adminSurveys.editTemplate' | transloco"
            >
              <mat-icon>edit</mat-icon>
            </button>

            @if (template.status !== 'archived') {
              <button
                mat-icon-button
                (click)="$event.stopPropagation(); toggleStatus(template)"
                [matTooltip]="
                  template.status === 'active'
                    ? ('common.deactivate' | transloco)
                    : ('common.activate' | transloco)
                "
              >
                <mat-icon>{{ template.status === 'active' ? 'pause' : 'play_arrow' }}</mat-icon>
              </button>
            }

            <button
              mat-icon-button
              [matMenuTriggerFor]="moreMenu"
              (click)="$event.stopPropagation()"
              [matTooltip]="'common.moreActions' | transloco"
            >
              <mat-icon>more_vert</mat-icon>
            </button>

            <mat-menu #moreMenu="matMenu">
              <button mat-menu-item (click)="cloneTemplate(template)">
                <mat-icon>content_copy</mat-icon>
                <span>{{ 'common.clone' | transloco }}</span>
              </button>
              @if (template.status !== 'archived') {
                <button mat-menu-item (click)="archiveTemplate(template)">
                  <mat-icon>archive</mat-icon>
                  <span>{{ 'common.archive' | transloco }}</span>
                </button>
              }
              @if (template.status === 'archived') {
                <button mat-menu-item (click)="unarchiveTemplate(template)">
                  <mat-icon>unarchive</mat-icon>
                  <span>{{ 'common.unarchive' | transloco }}</span>
                </button>
              }
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns"
          class="template-row"
          (click)="editTemplate(row)"
        ></tr>
      </table>
    </div>

    <div class="templates-summary">
      <span>{{
        dataSource.data.length === 1
          ? ('adminSurveys.templateCount' | transloco: { count: dataSource.data.length })
          : ('adminSurveys.templateCountPlural' | transloco: { count: dataSource.data.length })
      }}</span>
    </div>
  }
</div>

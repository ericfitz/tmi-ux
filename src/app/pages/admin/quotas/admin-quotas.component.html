<div class="admin-page-container">
  <div class="admin-header">
    <div class="header-content">
      <h1 [transloco]="'admin.quotas.title'">Manage Quotas</h1>
      <p class="subtitle" [transloco]="'admin.quotas.subtitle'">
        Configure rate limits and quotas for users
      </p>
    </div>
    <button
      mat-icon-button
      class="close-button"
      (click)="onClose()"
      [attr.aria-label]="'common.close' | transloco"
    >
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-card class="filter-card">
    <mat-card-content>
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label [transloco]="'admin.quotas.filterLabel'">Filter Quotas</mat-label>
        <input
          matInput
          [value]="filterText"
          (input)="onFilterChange($any($event.target).value)"
          [placeholder]="'admin.quotas.filterPlaceholder' | transloco"
        />
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>
    </mat-card-content>
  </mat-card>

  <!-- User API Quotas Section -->
  <mat-card class="quotas-card">
    <mat-card-header>
      <mat-card-title [transloco]="'admin.quotas.userAPITitle'">API Rate Limits</mat-card-title>
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="onAddQuota()">
          <mat-icon>add</mat-icon>
          <span [transloco]="'admin.quotas.addButton'">Add Quota</span>
        </button>
      </div>
    </mat-card-header>
    <mat-card-content>
      @if (loadingUserAPI) {
        <div class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
      } @else if (filteredUserAPIQuotas.length > 0) {
        <div class="quotas-table">
          <table mat-table [dataSource]="filteredUserAPIQuotas">
            <!-- Provider Column -->
            <ng-container matColumnDef="provider">
              <th mat-header-cell *matHeaderCellDef>Provider</th>
              <td mat-cell *matCellDef="let quota">
                <app-provider-display [providerInfo]="getProviderInfo(quota.provider)" />
              </td>
            </ng-container>

            <!-- User Info Column -->
            <ng-container matColumnDef="user">
              <th mat-header-cell *matHeaderCellDef>User</th>
              <td mat-cell *matCellDef="let quota">
                <div class="user-info">
                  @if (quota.user_name) {
                    <div class="user-name">{{ quota.user_name }}</div>
                  }
                  <div class="user-email">{{ quota.user_email }}</div>
                  <div class="user-provider-id">{{ quota.provider_id }}</div>
                </div>
              </td>
            </ng-container>

            <!-- Requests Per Minute Column -->
            <ng-container matColumnDef="requests_per_minute">
              <th mat-header-cell *matHeaderCellDef>Requests/Minute</th>
              <td mat-cell *matCellDef="let quota">
                @if (quota.editing) {
                  <mat-form-field class="quota-input">
                    <input
                      matInput
                      type="number"
                      [(ngModel)]="quota.editValues!.max_requests_per_minute"
                      min="1"
                    />
                  </mat-form-field>
                } @else {
                  {{ quota.max_requests_per_minute }}
                }
                <div class="default-hint">
                  Default: {{ defaultUserAPIQuota.max_requests_per_minute }}
                </div>
              </td>
            </ng-container>

            <!-- Requests Per Hour Column -->
            <ng-container matColumnDef="requests_per_hour">
              <th mat-header-cell *matHeaderCellDef>Requests/Hour</th>
              <td mat-cell *matCellDef="let quota">
                @if (quota.editing) {
                  <mat-form-field class="quota-input">
                    <input
                      matInput
                      type="number"
                      [(ngModel)]="quota.editValues!.max_requests_per_hour"
                      min="1"
                    />
                  </mat-form-field>
                } @else {
                  {{ quota.max_requests_per_hour ?? '-' }}
                }
                <div class="default-hint">
                  Default: {{ defaultUserAPIQuota.max_requests_per_hour }}
                </div>
              </td>
            </ng-container>

            <!-- Modified Column -->
            <ng-container matColumnDef="modified">
              <th mat-header-cell *matHeaderCellDef>Modified</th>
              <td mat-cell *matCellDef="let quota">
                {{ quota.modified_at | date: 'short' }}
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let quota">
                @if (quota.editing) {
                  <div class="action-buttons">
                    <button
                      mat-icon-button
                      color="primary"
                      (click)="onSaveUserAPIQuota(quota)"
                      [disabled]="quota.saving"
                      [matTooltip]="'common.save' | transloco"
                    >
                      <mat-icon>save</mat-icon>
                    </button>
                    <button
                      mat-icon-button
                      (click)="onCancelEditUserAPIQuota(quota)"
                      [disabled]="quota.saving"
                      [matTooltip]="'common.cancel' | transloco"
                    >
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                } @else {
                  <div class="action-buttons">
                    <button
                      mat-icon-button
                      (click)="onEditUserAPIQuota(quota)"
                      [matTooltip]="'common.edit' | transloco"
                    >
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button
                      mat-icon-button
                      color="warn"
                      (click)="onDeleteUserAPIQuota(quota)"
                      [matTooltip]="'admin.quotas.deleteTooltip' | transloco"
                    >
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                }
              </td>
            </ng-container>

            <tr
              mat-header-row
              *matHeaderRowDef="[
                'provider',
                'user',
                'requests_per_minute',
                'requests_per_hour',
                'modified',
                'actions',
              ]"
            ></tr>
            <tr
              mat-row
              *matRowDef="
                let row;
                columns: [
                  'provider',
                  'user',
                  'requests_per_minute',
                  'requests_per_hour',
                  'modified',
                  'actions',
                ]
              "
            ></tr>
          </table>
        </div>
      } @else {
        <div class="no-items-message">
          <mat-icon class="no-items-icon">speed</mat-icon>
          <p [transloco]="'admin.quotas.noUserAPIQuotas'">No custom API quotas found</p>
        </div>
      }

      <!-- User API Quota Paginator -->
      @if (!loadingUserAPI && totalUserAPIQuotas > 0) {
        <mat-paginator
          #userAPIPaginator
          [length]="totalUserAPIQuotas"
          [pageSize]="userAPIPageSize"
          [pageIndex]="userAPIPageIndex"
          [pageSizeOptions]="pageSizeOptions"
          (page)="onUserAPIPageChange($event)"
          showFirstLastButtons
          [attr.aria-label]="'pagination.ariaLabel' | transloco"
        >
        </mat-paginator>
      }
    </mat-card-content>
  </mat-card>

  <!-- Webhook Quotas Section -->
  <mat-card class="quotas-card">
    <mat-card-header>
      <mat-card-title [transloco]="'admin.quotas.webhookTitle'">Webhook Limits</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      @if (loadingWebhook) {
        <div class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
      } @else if (filteredWebhookQuotas.length > 0) {
        <div class="quotas-table">
          <table mat-table [dataSource]="filteredWebhookQuotas">
            <!-- Provider Column -->
            <ng-container matColumnDef="provider">
              <th mat-header-cell *matHeaderCellDef>Provider</th>
              <td mat-cell *matCellDef="let quota">
                <app-provider-display [providerInfo]="getProviderInfo(quota.provider)" />
              </td>
            </ng-container>

            <!-- User Info Column -->
            <ng-container matColumnDef="user">
              <th mat-header-cell *matHeaderCellDef>User</th>
              <td mat-cell *matCellDef="let quota">
                <div class="user-info">
                  @if (quota.user_name) {
                    <div class="user-name">{{ quota.user_name }}</div>
                  }
                  <div class="user-email">{{ quota.user_email }}</div>
                  <div class="user-provider-id">{{ quota.provider_id }}</div>
                </div>
              </td>
            </ng-container>

            <!-- Max Subscriptions Column -->
            <ng-container matColumnDef="max_subscriptions">
              <th mat-header-cell *matHeaderCellDef>Max Subscriptions</th>
              <td mat-cell *matCellDef="let quota">
                @if (quota.editing) {
                  <mat-form-field class="quota-input">
                    <input
                      matInput
                      type="number"
                      [(ngModel)]="quota.editValues!.max_subscriptions"
                      min="1"
                    />
                  </mat-form-field>
                } @else {
                  {{ quota.max_subscriptions }}
                }
                <div class="default-hint">Default: {{ defaultWebhookQuota.max_subscriptions }}</div>
              </td>
            </ng-container>

            <!-- Events Per Minute Column -->
            <ng-container matColumnDef="events_per_minute">
              <th mat-header-cell *matHeaderCellDef>Events/Min</th>
              <td mat-cell *matCellDef="let quota">
                @if (quota.editing) {
                  <mat-form-field class="quota-input">
                    <input
                      matInput
                      type="number"
                      [(ngModel)]="quota.editValues!.max_events_per_minute"
                      min="1"
                    />
                  </mat-form-field>
                } @else {
                  {{ quota.max_events_per_minute }}
                }
                <div class="default-hint">
                  Default: {{ defaultWebhookQuota.max_events_per_minute }}
                </div>
              </td>
            </ng-container>

            <!-- Subscription Requests Per Minute Column -->
            <ng-container matColumnDef="sub_req_per_minute">
              <th mat-header-cell *matHeaderCellDef>Sub Req/Min</th>
              <td mat-cell *matCellDef="let quota">
                @if (quota.editing) {
                  <mat-form-field class="quota-input">
                    <input
                      matInput
                      type="number"
                      [(ngModel)]="quota.editValues!.max_subscription_requests_per_minute"
                      min="1"
                    />
                  </mat-form-field>
                } @else {
                  {{ quota.max_subscription_requests_per_minute }}
                }
                <div class="default-hint">
                  Default: {{ defaultWebhookQuota.max_subscription_requests_per_minute }}
                </div>
              </td>
            </ng-container>

            <!-- Subscription Requests Per Day Column -->
            <ng-container matColumnDef="sub_req_per_day">
              <th mat-header-cell *matHeaderCellDef>Sub Req/Day</th>
              <td mat-cell *matCellDef="let quota">
                @if (quota.editing) {
                  <mat-form-field class="quota-input">
                    <input
                      matInput
                      type="number"
                      [(ngModel)]="quota.editValues!.max_subscription_requests_per_day"
                      min="1"
                    />
                  </mat-form-field>
                } @else {
                  {{ quota.max_subscription_requests_per_day }}
                }
                <div class="default-hint">
                  Default: {{ defaultWebhookQuota.max_subscription_requests_per_day }}
                </div>
              </td>
            </ng-container>

            <!-- Modified Column -->
            <ng-container matColumnDef="modified">
              <th mat-header-cell *matHeaderCellDef>Modified</th>
              <td mat-cell *matCellDef="let quota">
                {{ quota.modified_at | date: 'short' }}
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let quota">
                @if (quota.editing) {
                  <div class="action-buttons">
                    <button
                      mat-icon-button
                      color="primary"
                      (click)="onSaveWebhookQuota(quota)"
                      [disabled]="quota.saving"
                      [matTooltip]="'common.save' | transloco"
                    >
                      <mat-icon>save</mat-icon>
                    </button>
                    <button
                      mat-icon-button
                      (click)="onCancelEditWebhookQuota(quota)"
                      [disabled]="quota.saving"
                      [matTooltip]="'common.cancel' | transloco"
                    >
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                } @else {
                  <div class="action-buttons">
                    <button
                      mat-icon-button
                      (click)="onEditWebhookQuota(quota)"
                      [matTooltip]="'common.edit' | transloco"
                    >
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button
                      mat-icon-button
                      color="warn"
                      (click)="onDeleteWebhookQuota(quota)"
                      [matTooltip]="'admin.quotas.deleteTooltip' | transloco"
                    >
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                }
              </td>
            </ng-container>

            <tr
              mat-header-row
              *matHeaderRowDef="[
                'provider',
                'user',
                'max_subscriptions',
                'events_per_minute',
                'sub_req_per_minute',
                'sub_req_per_day',
                'modified',
                'actions',
              ]"
            ></tr>
            <tr
              mat-row
              *matRowDef="
                let row;
                columns: [
                  'provider',
                  'user',
                  'max_subscriptions',
                  'events_per_minute',
                  'sub_req_per_minute',
                  'sub_req_per_day',
                  'modified',
                  'actions',
                ]
              "
            ></tr>
          </table>
        </div>
      } @else {
        <div class="no-items-message">
          <mat-icon class="no-items-icon">webhook</mat-icon>
          <p [transloco]="'admin.quotas.noWebhookQuotas'">No custom webhook quotas found</p>
        </div>
      }

      <!-- Webhook Quota Paginator -->
      @if (!loadingWebhook && totalWebhookQuotas > 0) {
        <mat-paginator
          #webhookPaginator
          [length]="totalWebhookQuotas"
          [pageSize]="webhookPageSize"
          [pageIndex]="webhookPageIndex"
          [pageSizeOptions]="pageSizeOptions"
          (page)="onWebhookPageChange($event)"
          showFirstLastButtons
          [attr.aria-label]="'pagination.ariaLabel' | transloco"
        >
        </mat-paginator>
      }
    </mat-card-content>
  </mat-card>
</div>

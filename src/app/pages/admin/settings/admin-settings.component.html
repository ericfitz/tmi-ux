<div class="admin-page-container">
  <div class="admin-header">
    <div class="header-content">
      <h1 [transloco]="'admin.settings.title'">Manage Settings</h1>
      <p class="subtitle" [transloco]="'admin.settings.subtitle'">
        View and manage system configuration settings
      </p>
    </div>
    <div class="action-buttons">
      <button
        mat-icon-button
        (click)="onClose()"
        [attr.aria-label]="'common.close' | transloco"
        [matTooltip]="'common.close' | transloco"
      >
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <mat-card class="filter-card">
    <mat-card-content>
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label [transloco]="'admin.settings.filterLabel'">Filter</mat-label>
        <input
          matInput
          [value]="filterText"
          (input)="onFilterChange($any($event.target).value)"
          [placeholder]="'admin.settings.filterPlaceholder' | transloco"
        />
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>
    </mat-card-content>
  </mat-card>

  <mat-card class="settings-card">
    <mat-card-header>
      <mat-card-title [transloco]="'admin.settings.listTitle'">System Settings</mat-card-title>
      <div class="action-buttons">
        <button mat-stroked-button (click)="onMigrateSettings()">
          <mat-icon>sync</mat-icon>
          <span [transloco]="'admin.settings.migrateButton'">Migrate Settings</span>
        </button>
        <button mat-raised-button color="primary" (click)="onAddSetting()">
          <mat-icon>add</mat-icon>
          <span [transloco]="'admin.settings.addButton'">Add Setting</span>
        </button>
      </div>
    </mat-card-header>
    <mat-card-content>
      @if (loading) {
        <div class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
      } @else if (dataSource.data.length > 0) {
        <div class="settings-table">
          <table mat-table [dataSource]="dataSource" matSort>
            <!-- Key Column -->
            <ng-container matColumnDef="key">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ 'admin.settings.columns.key' | transloco }}
              </th>
              <td mat-cell *matCellDef="let setting">
                <span class="setting-key">{{ setting.key }}</span>
              </td>
            </ng-container>

            <!-- Value Column -->
            <ng-container matColumnDef="value">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ 'admin.settings.columns.value' | transloco }}
              </th>
              <td mat-cell *matCellDef="let setting">
                @if (setting.editing) {
                  @switch (setting.type) {
                    @case ('bool') {
                      <mat-slide-toggle
                        [checked]="getBoolValue(setting)"
                        (change)="onBoolToggle(setting, $event.checked)"
                      ></mat-slide-toggle>
                    }
                    @case ('int') {
                      <mat-form-field class="setting-input">
                        <input matInput type="number" [(ngModel)]="setting.editValues!.value" />
                      </mat-form-field>
                    }
                    @case ('json') {
                      <mat-form-field class="setting-input json-input">
                        <textarea
                          matInput
                          [(ngModel)]="setting.editValues!.value"
                          rows="3"
                          class="json-textarea"
                        ></textarea>
                      </mat-form-field>
                    }
                    @default {
                      <mat-form-field class="setting-input">
                        <input matInput type="text" [(ngModel)]="setting.editValues!.value" />
                      </mat-form-field>
                    }
                  }
                } @else {
                  @switch (setting.type) {
                    @case ('bool') {
                      <mat-icon class="bool-icon" [class.bool-true]="setting.value === 'true'">
                        {{ setting.value === 'true' ? 'check_circle' : 'cancel' }}
                      </mat-icon>
                    }
                    @case ('json') {
                      <span class="setting-value json-value">{{ setting.value }}</span>
                    }
                    @default {
                      <span class="setting-value">{{ setting.value }}</span>
                    }
                  }
                }
              </td>
            </ng-container>

            <!-- Type Column -->
            <ng-container matColumnDef="type">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ 'admin.settings.columns.type' | transloco }}
              </th>
              <td mat-cell *matCellDef="let setting">
                <span class="type-badge">
                  {{ 'admin.settings.types.' + setting.type | transloco }}
                </span>
              </td>
            </ng-container>

            <!-- Description Column -->
            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ 'admin.settings.columns.description' | transloco }}
              </th>
              <td mat-cell *matCellDef="let setting">
                @if (setting.editing) {
                  <mat-form-field class="setting-input">
                    <input matInput type="text" [(ngModel)]="setting.editValues!.description" />
                  </mat-form-field>
                } @else {
                  <span class="setting-description">{{ setting.description }}</span>
                }
              </td>
            </ng-container>

            <!-- Modified Column -->
            <ng-container matColumnDef="modified_at">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ 'admin.settings.columns.modified' | transloco }}
              </th>
              <td mat-cell *matCellDef="let setting">
                {{ setting.modified_at | date: 'short' }}
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>{{ 'common.actions' | transloco }}</th>
              <td mat-cell *matCellDef="let setting">
                @if (setting.editing) {
                  <div class="action-buttons">
                    <button
                      mat-icon-button
                      color="primary"
                      (click)="onSaveSetting(setting)"
                      [disabled]="setting.saving"
                      [matTooltip]="'admin.settings.saveTooltip' | transloco"
                    >
                      <mat-icon>save</mat-icon>
                    </button>
                    <button
                      mat-icon-button
                      (click)="onCancelEditSetting(setting)"
                      [disabled]="setting.saving"
                      [matTooltip]="'admin.settings.cancelTooltip' | transloco"
                    >
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                } @else {
                  <div class="action-buttons">
                    <button
                      mat-icon-button
                      (click)="onEditSetting(setting)"
                      [matTooltip]="'admin.settings.editTooltip' | transloco"
                    >
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button
                      mat-icon-button
                      color="warn"
                      (click)="onDeleteSetting(setting)"
                      [matTooltip]="'admin.settings.deleteTooltip' | transloco"
                    >
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                }
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </div>
      } @else {
        <div class="no-items-message">
          <mat-icon class="no-items-icon">settings</mat-icon>
          <p [transloco]="'admin.settings.noSettings'">No settings found</p>
        </div>
      }

      @if (!loading && totalSettings > 0) {
        <mat-paginator
          [length]="dataSource.data.length"
          [pageSize]="pageSize"
          [pageIndex]="pageIndex"
          [pageSizeOptions]="pageSizeOptions"
          (page)="onPageChange($event)"
          showFirstLastButtons
          [attr.aria-label]="'pagination.ariaLabel' | transloco"
        >
        </mat-paginator>
      }
    </mat-card-content>
  </mat-card>
</div>
